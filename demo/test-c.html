<pre>
<span style='color:#696969; '>/* Copyright 2001-2004 The Apache Software Foundation</span>
<span style='color:#696969; '> *</span>
<span style='color:#696969; '> * Licensed under the Apache License, Version 2.0 (the "License");</span>
<span style='color:#696969; '> * you may not use this file except in compliance with the License.</span>
<span style='color:#696969; '> * You may obtain a copy of the License at</span>
<span style='color:#696969; '> *</span>
<span style='color:#696969; '> *     </span><span style='color:#5555dd; '>http://www.apache.org/licenses/LICENSE-2.0</span><span style='color:#696969; '></span>
<span style='color:#696969; '> *</span>
<span style='color:#696969; '> * Unless required by applicable law or agreed to in writing, software</span>
<span style='color:#696969; '> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span style='color:#696969; '> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style='color:#696969; '> * See the License for the specific language governing permissions and</span>
<span style='color:#696969; '> * limitations under the License.</span>
<span style='color:#696969; '> */</span>
<span style='color:#3f5fbf; '>/**</span>
<span style='color:#3f5fbf; '> * This MPM tries to </span><span style='color:#ffffff; background:#808000; '>fix the 'keep alive problem' in HTTP.</span><span style='color:#3f5fbf; '></span>
<span style='color:#3f5fbf; '> *</span>
<span style='color:#3f5fbf; '> * After a client completes the first request, it can keep it open to send more </span>
<span style='color:#3f5fbf; '> * requests with the same socket.  This can save signifigant overhead in </span>
<span style='color:#3f5fbf; '> * creating TCP connections.  However, the major disadvantage is that Apache</span>
<span style='color:#3f5fbf; '> * traditionally keeps an entire child process/thread waiting for data from</span>
<span style='color:#3f5fbf; '> * the client.  This MPM has a dedicated thread for handling both the </span>
<span style='color:#3f5fbf; '> * Listenting sockets, and all sockets that are in a Keep Alive status.</span>
<span style='color:#3f5fbf; '> * </span>
<span style='color:#3f5fbf; '> * The MPM assumes the underlying apr_pollset implmentation is somewhat threadsafe.</span>
<span style='color:#3f5fbf; '> * This currently is only comptaible with KQueue and EPoll.  This enables the</span>
<span style='color:#3f5fbf; '> * MPM to avoid extra high level locking or having to wake up the listener </span>
<span style='color:#3f5fbf; '> * thread when a keep-alive socket needs to be sent to it.</span>
<span style='color:#3f5fbf; '> * </span>
<span style='color:#3f5fbf; '> * This MPM not preform well on older platforms that do not have very good </span>
<span style='color:#3f5fbf; '> * threading, like Linux with a 2.4 kernel, but this does not matter, since we </span>
<span style='color:#3f5fbf; '> * require EPoll or KQueue.</span>
<span style='color:#3f5fbf; '> *</span>
<span style='color:#3f5fbf; '> * For FreeBSD, use 5.3.  It is possible to run this MPM</span>
<span style='color:#3f5fbf; '> * on FreeBSD 5.2.1, if you use libkse (see `man libmap.conf`).</span>
<span style='color:#3f5fbf; '> *</span>
<span style='color:#3f5fbf; '> * For NetBSD, use at least 2.0.</span>
<span style='color:#3f5fbf; '> *</span>
<span style='color:#3f5fbf; '> * For Linux, you should use a2.6 kernel, and make sure your glibc has epoll </span>
<span style='color:#3f5fbf; '> * support compiled in.</span>
<span style='color:#3f5fbf; '> *</span>
<span style='color:#3f5fbf; '> */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_portable.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_strings.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_file_io.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_thread_proc.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_signal.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_thread_mutex.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_proc_mutex.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_poll.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_ring.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_queue.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> APR_WANT_STRFUNC</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>apr_want.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>if</span><span style='color:#004a43; '> APR_HAVE_UNISTD_H</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>unistd.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>if</span><span style='color:#004a43; '> APR_HAVE_SYS_SOCKET_H</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>sys/socket.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>if</span><span style='color:#004a43; '> APR_HAVE_SYS_WAIT_H</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>sys/wait.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> HAVE_SYS_PROCESSOR_H</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>sys/processor.h</span><span style='color:#800000; '>></span><span style='color:#004a43; '>      </span><span style='color:#696969; '>/* for bindprocessor() */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>if</span><span style='color:#004a43; '> </span><span style='color:#808030; '>!</span><span style='color:#004a43; '>APR_HAS_THREADS</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>error</span><span style='color:#004a43; '> The Event MPM requires APR threads</span><span style='color:#808030; '>,</span><span style='color:#004a43; '> but they are unavailable</span><span style='color:#808030; '>.</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> CORE_PRIVATE</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>ap_config.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>httpd.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>http_main.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>http_log.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>http_config.h</span><span style='color:#800000; '>"</span><span style='color:#004a43; '>        </span><span style='color:#696969; '>/* for read_config */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>http_core.h</span><span style='color:#800000; '>"</span><span style='color:#004a43; '>          </span><span style='color:#696969; '>/* for get_remote_host */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>http_connection.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>ap_mpm.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>pod.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>mpm_common.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>ap_listen.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>scoreboard.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>fdqueue.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>mpm_default.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>"</span><span style='color:#40015a; '>http_vhost.h</span><span style='color:#800000; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>signal.h</span><span style='color:#800000; '>></span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#800000; '>&lt;</span><span style='color:#40015a; '>limits.h</span><span style='color:#800000; '>></span><span style='color:#004a43; '>             </span><span style='color:#696969; '>/* for INT_MAX */</span>
<span style='color:#696969; '>/* Limit on the total --- clients will be locked out if more servers than</span>
<span style='color:#696969; '> * this are needed.  It is intended solely to keep the server from crashing</span>
<span style='color:#696969; '> * when things get out of hand.</span>
<span style='color:#696969; '> *</span>
<span style='color:#696969; '> * We keep a hard maximum number of servers, for two reasons --- first off,</span>
<span style='color:#696969; '> * in case something goes seriously wrong, we want to stop the fork bomb</span>
<span style='color:#696969; '> * short of actually crashing the machine we're running on by filling some</span>
<span style='color:#696969; '> * kernel table.  Secondly, it keeps the size of the scoreboard file small</span>
<span style='color:#696969; '> * enough that we can read the whole thing without worrying too much about</span>
<span style='color:#696969; '> * the overhead.</span>
<span style='color:#696969; '> */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifndef</span><span style='color:#004a43; '> DEFAULT_SERVER_LIMIT</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> DEFAULT_SERVER_LIMIT 16</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#696969; '>/* Admin can't tune ServerLimit beyond MAX_SERVER_LIMIT.  We want</span>
<span style='color:#696969; '> * some sort of compile-time limit to help catch typos.</span>
<span style='color:#696969; '> */</span>   
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifndef</span><span style='color:#004a43; '> MAX_SERVER_LIMIT   </span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> MAX_SERVER_LIMIT 20000</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#696969; '>/* Limit on the threads per process.  Clients will be locked out if more than</span>
<span style='color:#696969; '> * this are needed.</span>
<span style='color:#696969; '> *</span>
<span style='color:#696969; '> * We keep this for one reason it keeps the size of the scoreboard file small</span>
<span style='color:#696969; '> * enough that we can read the whole thing without worrying too much about</span>
<span style='color:#696969; '> * the overhead.</span>
<span style='color:#696969; '> */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifndef</span><span style='color:#004a43; '> DEFAULT_THREAD_LIMIT</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> DEFAULT_THREAD_LIMIT 64</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#696969; '>/* Admin can't tune ThreadLimit beyond MAX_THREAD_LIMIT.  We want</span>
<span style='color:#696969; '> * some sort of compile-time limit to help catch typos.</span>
<span style='color:#696969; '> */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifndef</span><span style='color:#004a43; '> MAX_THREAD_LIMIT</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> MAX_THREAD_LIMIT 100000</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#696969; '>/*</span>
<span style='color:#696969; '> * Actual definitions of config globals</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>int</span> ap_threads_per_child <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>   <span style='color:#696969; '>/* Worker threads per child */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> ap_daemons_to_start <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> min_spare_threads <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> max_spare_threads <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> ap_daemons_limit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> server_limit <span style='color:#808030; '>=</span> DEFAULT_SERVER_LIMIT<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> first_server_limit<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> thread_limit <span style='color:#808030; '>=</span> DEFAULT_THREAD_LIMIT<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> first_thread_limit<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> changed_limit_at_restart<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> dying <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> workers_may_exit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> start_thread_may_exit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> listener_may_exit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> requests_this_child<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> num_listensocks <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> resource_shortage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> fd_queue_t <span style='color:#808030; '>*</span>worker_queue<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> fd_queue_info_t <span style='color:#808030; '>*</span>worker_queue_info<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STARTING<span style='color:#800080; '>;</span>
apr_thread_mutex_t <span style='color:#808030; '>*</span>timeout_mutex<span style='color:#800080; '>;</span>
APR_RING_HEAD<span style='color:#808030; '>(</span>timeout_head_t<span style='color:#808030; '>,</span> conn_state_t<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>struct</span> timeout_head_t timeout_head<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> apr_pollset_t <span style='color:#808030; '>*</span>event_pollset<span style='color:#800080; '>;</span>
<span style='color:#696969; '>/* The structure used to pass unique initialization info to each thread */</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>struct</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> pid<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> tid<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> sd<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span> proc_info<span style='color:#800080; '>;</span>
<span style='color:#696969; '>/* Structure used to pass information to the thread responsible for </span>
<span style='color:#696969; '> * creating the rest of the threads.</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>struct</span>
<span style='color:#800080; '>{</span>
    apr_thread_t <span style='color:#808030; '>*</span><span style='color:#808030; '>*</span>threads<span style='color:#800080; '>;</span>
    apr_thread_t <span style='color:#808030; '>*</span>listener<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> child_num_arg<span style='color:#800080; '>;</span>
    apr_threadattr_t <span style='color:#808030; '>*</span>threadattr<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span> thread_starter<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>enum</span>
<span style='color:#800080; '>{</span>
    PT_CSD<span style='color:#808030; '>,</span>
    PT_ACCEPT
<span style='color:#800080; '>}</span> poll_type_e<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>struct</span>
<span style='color:#800080; '>{</span>
    poll_type_e type<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> status<span style='color:#800080; '>;</span>        <span style='color:#696969; '>/*XXX what is this for?  0 and 1 don't make it clear */</span>
    <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>baton<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span> listener_poll_type<span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> ID_FROM_CHILD_THREAD</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>c</span><span style='color:#808030; '>,</span><span style='color:#004a43; '> t</span><span style='color:#808030; '>)</span><span style='color:#004a43; '>    </span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>c </span><span style='color:#808030; '>*</span><span style='color:#004a43; '> thread_limit</span><span style='color:#808030; '>)</span><span style='color:#004a43; '> </span><span style='color:#808030; '>+</span><span style='color:#004a43; '> t</span><span style='color:#808030; '>)</span>
<span style='color:#696969; '>/*</span>
<span style='color:#696969; '> * The max child slot ever assigned, preserved across restarts.  Necessary</span>
<span style='color:#696969; '> * to deal with MaxClients changes across AP_SIG_GRACEFUL restarts.  We </span>
<span style='color:#696969; '> * use this value to optimize routines that have to scan the entire </span>
<span style='color:#696969; '> * scoreboard.</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>int</span> ap_max_daemons_limit <span style='color:#808030; '>=</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> ap_pod_t <span style='color:#808030; '>*</span>pod<span style='color:#800080; '>;</span>
<span style='color:#696969; '>/* *Non*-shared http_main globals... */</span>
server_rec <span style='color:#808030; '>*</span>ap_server_conf<span style='color:#800080; '>;</span>
<span style='color:#696969; '>/* The worker MPM respects a couple of runtime flags that can aid</span>
<span style='color:#696969; '> * in debugging. Setting the -DNO_DETACH flag will prevent the root process</span>
<span style='color:#696969; '> * from detaching from its controlling terminal. Additionally, setting</span>
<span style='color:#696969; '> * the -DONE_PROCESS flag (which implies -DNO_DETACH) will get you the</span>
<span style='color:#696969; '> * child_main loop running in the process which originally started up.</span>
<span style='color:#696969; '> * This gives you a pretty nice debugging environment.  (You'll get a SIGHUP</span>
<span style='color:#696969; '> * early in standalone_main; just continue through.  This is the server</span>
<span style='color:#696969; '> * trying to kill off any child processes which it might have lying</span>
<span style='color:#696969; '> * around --- Apache doesn't keep track of their pids, it just sends</span>
<span style='color:#696969; '> * SIGHUP to the process group, ignoring it in the root process.</span>
<span style='color:#696969; '> * Continue through and you'll be fine.).</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> one_process <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> DEBUG_SIGSTOP</span>
<span style='color:#800000; font-weight:bold; '>int</span> raise_sigstop_flags<span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#800000; font-weight:bold; '>static</span> apr_pool_t <span style='color:#808030; '>*</span>pconf<span style='color:#800080; '>;</span>       <span style='color:#696969; '>/* Pool for config stuff */</span>
<span style='color:#800000; font-weight:bold; '>static</span> apr_pool_t <span style='color:#808030; '>*</span>pchild<span style='color:#800080; '>;</span>      <span style='color:#696969; '>/* Pool for httpd child stuff */</span>
<span style='color:#800000; font-weight:bold; '>static</span> pid_t ap_my_pid<span style='color:#800080; '>;</span>         <span style='color:#696969; '>/* Linux getpid() doesn't work except in main </span>
<span style='color:#696969; '>                                   thread. Use this instead */</span>
<span style='color:#800000; font-weight:bold; '>static</span> pid_t parent_pid<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> apr_os_thread_t <span style='color:#808030; '>*</span>listener_os_thread<span style='color:#800080; '>;</span>
<span style='color:#696969; '>/* The LISTENER_SIGNAL signal will be sent from the main thread to the </span>
<span style='color:#696969; '> * listener thread to wake it up for graceful termination (what a child </span>
<span style='color:#696969; '> * process from an old generation does when the admin does "apachectl </span>
<span style='color:#696969; '> * graceful").  This signal will be blocked in all threads of a child</span>
<span style='color:#696969; '> * process except for the listener thread.</span>
<span style='color:#696969; '> */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> LISTENER_SIGNAL     SIGHUP</span>
<span style='color:#696969; '>/* An array of socket descriptors in use by each thread used to</span>
<span style='color:#696969; '> * perform a non-graceful (forced) shutdown of the server. */</span>
<span style='color:#800000; font-weight:bold; '>static</span> apr_socket_t <span style='color:#808030; '>*</span><span style='color:#808030; '>*</span>worker_sockets<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> close_worker_sockets<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> ap_threads_per_child<span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>worker_sockets<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            apr_socket_close<span style='color:#808030; '>(</span>worker_sockets<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            worker_sockets<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> wakeup_listener<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    listener_may_exit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>listener_os_thread<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* XXX there is an obscure path that this doesn't handle perfectly:</span>
<span style='color:#696969; '>         *     right after listener thread is created but before </span>
<span style='color:#696969; '>         *     listener_os_thread is set, the first worker thread hits an</span>
<span style='color:#696969; '>         *     error and starts graceful termination</span>
<span style='color:#696969; '>         */</span>
        <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/*</span>
<span style='color:#696969; '>     * we should just be able to "kill(ap_my_pid, LISTENER_SIGNAL)" on all</span>
<span style='color:#696969; '>     * platforms and wake up the listener thread since it is the only thread </span>
<span style='color:#696969; '>     * with SIGHUP unblocked, but that doesn't work on Linux</span>
<span style='color:#696969; '>     */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> HAVE_PTHREAD_KILL</span>
    pthread_kill<span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>listener_os_thread<span style='color:#808030; '>,</span> LISTENER_SIGNAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>else</span>
    kill<span style='color:#808030; '>(</span>ap_my_pid<span style='color:#808030; '>,</span> LISTENER_SIGNAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#800080; '>}</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> ST_INIT              0</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> ST_GRACEFUL          1</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> ST_UNGRACEFUL        2</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> terminate_mode <span style='color:#808030; '>=</span> ST_INIT<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> signal_threads<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> mode<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>terminate_mode <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> mode<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    terminate_mode <span style='color:#808030; '>=</span> mode<span style='color:#800080; '>;</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STOPPING<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* in case we weren't called from the listener thread, wake up the</span>
<span style='color:#696969; '>     * listener thread</span>
<span style='color:#696969; '>     */</span>
    wakeup_listener<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* for ungraceful termination, let the workers exit now;</span>
<span style='color:#696969; '>     * for graceful termination, the listener thread will notify the</span>
<span style='color:#696969; '>     * workers to exit once it has stopped accepting new connections</span>
<span style='color:#696969; '>     */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>mode <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> ST_UNGRACEFUL<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        workers_may_exit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        ap_queue_interrupt_all<span style='color:#808030; '>(</span>worker_queue<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_queue_info_term<span style='color:#808030; '>(</span>worker_queue_info<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        close_worker_sockets<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> <span style='color:#696969; '>/* forcefully kill all current connections */</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
AP_DECLARE<span style='color:#808030; '>(</span>apr_status_t<span style='color:#808030; '>)</span> ap_mpm_query<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> query_code<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>int</span> <span style='color:#808030; '>*</span>result<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>switch</span> <span style='color:#808030; '>(</span>query_code<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MAX_DAEMON_USED</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> ap_max_daemons_limit<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_IS_THREADED</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> AP_MPMQ_STATIC<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_IS_FORKED</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> AP_MPMQ_DYNAMIC<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_IS_ASYNC</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_HARD_LIMIT_DAEMONS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> server_limit<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_HARD_LIMIT_THREADS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> thread_limit<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MAX_THREADS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> ap_threads_per_child<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MIN_SPARE_DAEMONS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MIN_SPARE_THREADS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> min_spare_threads<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MAX_SPARE_DAEMONS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MAX_SPARE_THREADS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> max_spare_threads<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MAX_REQUESTS_DAEMON</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> ap_max_requests_per_child<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MAX_DAEMONS</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> ap_daemons_limit<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>AP_MPMQ_MPM_STATE</span><span style='color:#e34adc; '>:</span>
        <span style='color:#808030; '>*</span>result <span style='color:#808030; '>=</span> mpm_state<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> APR_ENOTIMPL<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/* a clean exit from a child with proper cleanup */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> clean_child_exit<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> code<span style='color:#808030; '>)</span> __attribute__ <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>noreturn<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> clean_child_exit<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> code<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STOPPING<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>pchild<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        apr_pool_destroy<span style='color:#808030; '>(</span>pchild<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    exit<span style='color:#808030; '>(</span>code<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> just_die<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> sig<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    clean_child_exit<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#3f5fbf; '>/*****************************************************************</span>
<span style='color:#3f5fbf; '> * Connection structures and accounting...</span>
<span style='color:#3f5fbf; '> */</span>
<span style='color:#696969; '>/* volatile just in case */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> <span style='color:#800000; font-weight:bold; '>volatile</span> shutdown_pending<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> <span style='color:#800000; font-weight:bold; '>volatile</span> restart_pending<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> <span style='color:#800000; font-weight:bold; '>volatile</span> is_graceful<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>volatile</span> <span style='color:#800000; font-weight:bold; '>int</span> child_fatal<span style='color:#800080; '>;</span>
ap_generation_t <span style='color:#800000; font-weight:bold; '>volatile</span> ap_my_generation<span style='color:#800080; '>;</span>
<span style='color:#696969; '>/*</span>
<span style='color:#696969; '> * ap_start_shutdown() and ap_start_restart(), below, are a first stab at</span>
<span style='color:#696969; '> * functions to initiate shutdown or restart without relying on signals. </span>
<span style='color:#696969; '> * Previously this was initiated in sig_term() and restart() signal handlers, </span>
<span style='color:#696969; '> * but we want to be able to start a shutdown/restart from other sources --</span>
<span style='color:#696969; '> * e.g. on Win32, from the service manager. Now the service manager can</span>
<span style='color:#696969; '> * call ap_start_shutdown() or ap_start_restart() as appropiate.  Note that</span>
<span style='color:#696969; '> * these functions can also be called by the child processes, since global</span>
<span style='color:#696969; '> * variables are no longer used to pass on the required action to the parent.</span>
<span style='color:#696969; '> *</span>
<span style='color:#696969; '> * These should only be called from the parent process itself, since the</span>
<span style='color:#696969; '> * parent process will use the shutdown_pending and restart_pending variables</span>
<span style='color:#696969; '> * to determine whether to shutdown or restart. The child process should</span>
<span style='color:#696969; '> * call signal_parent() directly to tell the parent to die -- this will</span>
<span style='color:#696969; '> * cause neither of those variable to be set, which the parent will</span>
<span style='color:#696969; '> * assume means something serious is wrong (which it will be, for the</span>
<span style='color:#696969; '> * child to force an exit) and so do an exit anyway.</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> ap_start_shutdown<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STOPPING<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>shutdown_pending <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* Um, is this _probably_ not an error, if the user has</span>
<span style='color:#696969; '>         * tried to do a shutdown twice quickly, so we won't</span>
<span style='color:#696969; '>         * worry about reporting it.</span>
<span style='color:#696969; '>         */</span>
        <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    shutdown_pending <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/* do a graceful restart if graceful == 1 */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> ap_start_restart<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> graceful<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STOPPING<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>restart_pending <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* Probably not an error - don't bother reporting it */</span>
        <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    restart_pending <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    is_graceful <span style='color:#808030; '>=</span> graceful<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> sig_term<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> sig<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    ap_start_shutdown<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> restart<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> sig<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    ap_start_restart<span style='color:#808030; '>(</span>sig <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> AP_SIG_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> set_signals<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifndef</span><span style='color:#004a43; '> NO_USE_SIGACTION</span>
    <span style='color:#800000; font-weight:bold; '>struct</span> sigaction sa<span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>one_process<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_fatal_signal_setup<span style='color:#808030; '>(</span>ap_server_conf<span style='color:#808030; '>,</span> pconf<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifndef</span><span style='color:#004a43; '> NO_USE_SIGACTION</span>
    sigemptyset<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>.</span>sa_mask<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    sa<span style='color:#808030; '>.</span>sa_flags <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    sa<span style='color:#808030; '>.</span>sa_handler <span style='color:#808030; '>=</span> sig_term<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGTERM<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"sigaction(SIGTERM)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGINT</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGINT<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"sigaction(SIGINT)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGXCPU</span>
    sa<span style='color:#808030; '>.</span>sa_handler <span style='color:#808030; '>=</span> SIG_DFL<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGXCPU<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"sigaction(SIGXCPU)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGXFSZ</span>
    sa<span style='color:#808030; '>.</span>sa_handler <span style='color:#808030; '>=</span> SIG_DFL<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGXFSZ<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"sigaction(SIGXFSZ)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGPIPE</span>
    sa<span style='color:#808030; '>.</span>sa_handler <span style='color:#808030; '>=</span> SIG_IGN<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGPIPE<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"sigaction(SIGPIPE)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
    <span style='color:#696969; '>/* we want to ignore HUPs and AP_SIG_GRACEFUL while we're busy </span>
<span style='color:#696969; '>     * processing one */</span>
    sigaddset<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>.</span>sa_mask<span style='color:#808030; '>,</span> SIGHUP<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    sigaddset<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>.</span>sa_mask<span style='color:#808030; '>,</span> AP_SIG_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    sa<span style='color:#808030; '>.</span>sa_handler <span style='color:#808030; '>=</span> restart<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>SIGHUP<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"sigaction(SIGHUP)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>sigaction<span style='color:#808030; '>(</span>AP_SIG_GRACEFUL<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sa<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"sigaction("</span> AP_SIG_GRACEFUL_STRING <span style='color:#0000e6; '>")"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>else</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>one_process<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGXCPU</span>
        apr_signal<span style='color:#808030; '>(</span>SIGXCPU<span style='color:#808030; '>,</span> SIG_DFL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span><span style='color:#004a43; '> </span><span style='color:#696969; '>/* SIGXCPU */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGXFSZ</span>
        apr_signal<span style='color:#808030; '>(</span>SIGXFSZ<span style='color:#808030; '>,</span> SIG_DFL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span><span style='color:#004a43; '> </span><span style='color:#696969; '>/* SIGXFSZ */</span>
    <span style='color:#800080; '>}</span>
    apr_signal<span style='color:#808030; '>(</span>SIGTERM<span style='color:#808030; '>,</span> sig_term<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGHUP</span>
    apr_signal<span style='color:#808030; '>(</span>SIGHUP<span style='color:#808030; '>,</span> restart<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span><span style='color:#004a43; '> </span><span style='color:#696969; '>/* SIGHUP */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> AP_SIG_GRACEFUL</span>
    apr_signal<span style='color:#808030; '>(</span>AP_SIG_GRACEFUL<span style='color:#808030; '>,</span> restart<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span><span style='color:#004a43; '> </span><span style='color:#696969; '>/* AP_SIG_GRACEFUL */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> SIGPIPE</span>
    apr_signal<span style='color:#808030; '>(</span>SIGPIPE<span style='color:#808030; '>,</span> SIG_IGN<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span><span style='color:#004a43; '> </span><span style='color:#696969; '>/* SIGPIPE */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#800080; '>}</span>
<span style='color:#3f5fbf; '>/*****************************************************************</span>
<span style='color:#3f5fbf; '> * Here follows a long bunch of generic server bookkeeping stuff...</span>
<span style='color:#3f5fbf; '> */</span>
<span style='color:#800000; font-weight:bold; '>int</span> ap_graceful_stop_signalled<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>)</span>
    <span style='color:#696969; '>/* XXX this is really a bad confusing obsolete name</span>
<span style='color:#696969; '>     * maybe it should be ap_mpm_process_exiting?</span>
<span style='color:#696969; '>     */</span>
<span style='color:#800080; '>{</span>
    <span style='color:#696969; '>/* note: for a graceful termination, listener_may_exit will be set before</span>
<span style='color:#696969; '>     *       workers_may_exit, so check listener_may_exit</span>
<span style='color:#696969; '>     */</span>
    <span style='color:#800000; font-weight:bold; '>return</span> listener_may_exit<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#3f5fbf; '>/*****************************************************************</span>
<span style='color:#3f5fbf; '> * Child process main loop.</span>
<span style='color:#3f5fbf; '> */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> process_socket<span style='color:#808030; '>(</span>apr_pool_t <span style='color:#808030; '>*</span> p<span style='color:#808030; '>,</span> apr_socket_t <span style='color:#808030; '>*</span> sock<span style='color:#808030; '>,</span>
                          conn_state_t <span style='color:#808030; '>*</span> cs<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>int</span> my_child_num<span style='color:#808030; '>,</span>
                          <span style='color:#800000; font-weight:bold; '>int</span> my_thread_num<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    conn_rec <span style='color:#808030; '>*</span>c<span style='color:#800080; '>;</span>
    listener_poll_type <span style='color:#808030; '>*</span>pt<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>long</span> conn_id <span style='color:#808030; '>=</span> ID_FROM_CHILD_THREAD<span style='color:#808030; '>(</span>my_child_num<span style='color:#808030; '>,</span> my_thread_num<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> csd<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> rc<span style='color:#800080; '>;</span>
    apr_time_t time_now <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    ap_sb_handle_t <span style='color:#808030; '>*</span>sbh<span style='color:#800080; '>;</span>
    ap_create_sb_handle<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>sbh<span style='color:#808030; '>,</span> p<span style='color:#808030; '>,</span> my_child_num<span style='color:#808030; '>,</span> my_thread_num<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    apr_os_sock_get<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>csd<span style='color:#808030; '>,</span> sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    time_now <span style='color:#808030; '>=</span> apr_time_now<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>cs <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>           <span style='color:#696969; '>/* This is a new connection */</span>
        cs <span style='color:#808030; '>=</span> apr_pcalloc<span style='color:#808030; '>(</span>p<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>conn_state_t<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        pt <span style='color:#808030; '>=</span> apr_pcalloc<span style='color:#808030; '>(</span>p<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>pt<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>bucket_alloc <span style='color:#808030; '>=</span> apr_bucket_alloc_create<span style='color:#808030; '>(</span>p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        c <span style='color:#808030; '>=</span> ap_run_create_connection<span style='color:#808030; '>(</span>p<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span> sock<span style='color:#808030; '>,</span>
                                     conn_id<span style='color:#808030; '>,</span> sbh<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>bucket_alloc<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>c <span style='color:#808030; '>=</span> c<span style='color:#800080; '>;</span>
        c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>cs <span style='color:#808030; '>=</span> cs<span style='color:#800080; '>;</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>p <span style='color:#808030; '>=</span> p<span style='color:#800080; '>;</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>.</span>desc_type <span style='color:#808030; '>=</span> APR_POLL_SOCKET<span style='color:#800080; '>;</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>.</span>reqevents <span style='color:#808030; '>=</span> APR_POLLIN<span style='color:#800080; '>;</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>.</span>desc<span style='color:#808030; '>.</span>s <span style='color:#808030; '>=</span> sock<span style='color:#800080; '>;</span>
        pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>type <span style='color:#808030; '>=</span> PT_CSD<span style='color:#800080; '>;</span>
        pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>status <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>baton <span style='color:#808030; '>=</span> cs<span style='color:#800080; '>;</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>.</span>client_data <span style='color:#808030; '>=</span> pt<span style='color:#800080; '>;</span>
        ap_update_vhost_given_ip<span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        rc <span style='color:#808030; '>=</span> ap_run_pre_connection<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span> sock<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> OK <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> DONE<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_DEBUG<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                         <span style='color:#0000e6; '>"process_socket: connection aborted"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>aborted <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#3f5fbf; '>/**</span>
<span style='color:#3f5fbf; '>         * XXX If the platform does not have a usable way of bundling </span>
<span style='color:#3f5fbf; '>         * accept() with a socket readability check, like Win32, </span>
<span style='color:#3f5fbf; '>         * and there are measurable delays before the</span>
<span style='color:#3f5fbf; '>         * socket is readable due to the first data packet arriving,</span>
<span style='color:#3f5fbf; '>         * it might be better to create the cs on the listener thread,</span>
<span style='color:#3f5fbf; '>         * set the state to CONN_STATE_CHECK_REQUEST_LINE_READABLE,</span>
<span style='color:#3f5fbf; '>         * and give it to the event thread.</span>
<span style='color:#3f5fbf; '>         *</span>
<span style='color:#3f5fbf; '>         * FreeBSD users will want to enable the HTTP accept filter </span>
<span style='color:#3f5fbf; '>         * module in their kernel for the highest performance</span>
<span style='color:#3f5fbf; '>         * When the accept filter is active, sockets are kept in the</span>
<span style='color:#3f5fbf; '>         * kernel until a HTTP request is received.</span>
<span style='color:#3f5fbf; '>         */</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span> CONN_STATE_READ_REQUEST_LINE<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
        c <span style='color:#808030; '>=</span> cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>c<span style='color:#800080; '>;</span>
        c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>sbh <span style='color:#808030; '>=</span> sbh<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> CONN_STATE_READ_REQUEST_LINE<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>aborted<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            ap_run_process_connection<span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>/* state will be updated upon return</span>
<span style='color:#696969; '>             * fall thru to either wait for readability/timeout or</span>
<span style='color:#696969; '>             * do lingering close</span>
<span style='color:#696969; '>             */</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
            cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span> CONN_STATE_LINGER<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> CONN_STATE_LINGER<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_lingering_close<span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_bucket_alloc_destroy<span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>bucket_alloc<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_pool_clear<span style='color:#808030; '>(</span>p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_push_pool<span style='color:#808030; '>(</span>worker_queue_info<span style='color:#808030; '>,</span> p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> CONN_STATE_CHECK_REQUEST_LINE_READABLE<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        apr_status_t rc<span style='color:#800080; '>;</span>
        listener_poll_type <span style='color:#808030; '>*</span>pt <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>listener_poll_type <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>.</span>client_data<span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* It greatly simplifies the logic to use a single timeout value here </span>
<span style='color:#696969; '>         * because the new element can just be added to the end of the list </span>
<span style='color:#696969; '>         * and it will stay sorted in expiration time sequence.  If brand new </span>
<span style='color:#696969; '>         * sockets are sent to the event thread for a readability check, this </span>
<span style='color:#696969; '>         * will be a slight behavior change - they use the non-keepalive timeout </span>
<span style='color:#696969; '>         * today.  With a normal client, the socket will be readable in a few </span>
<span style='color:#696969; '>         * milliseconds anyway.    </span>
<span style='color:#696969; '>         */</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>expiration_time <span style='color:#808030; '>=</span> ap_server_conf<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>keep_alive_timeout <span style='color:#808030; '>+</span> time_now<span style='color:#800080; '>;</span>
        apr_thread_mutex_lock<span style='color:#808030; '>(</span>timeout_mutex<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        APR_RING_INSERT_TAIL<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>timeout_head<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>,</span> conn_state_t<span style='color:#808030; '>,</span> timeout_list<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>status <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* Add work to pollset. These are always read events */</span>
        rc <span style='color:#808030; '>=</span> apr_pollset_add<span style='color:#808030; '>(</span>event_pollset<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_thread_mutex_unlock<span style='color:#808030; '>(</span>timeout_mutex<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ERR<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                         <span style='color:#0000e6; '>"process_socket: apr_pollset_add failure"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            AP_DEBUG_ASSERT<span style='color:#808030; '>(</span>rc <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/* requests_this_child has gone to zero or below.  See if the admin coded</span>
<span style='color:#696969; '>   "MaxRequestsPerChild 0", and keep going in that case.  Doing it this way</span>
<span style='color:#696969; '>   simplifies the hot path in worker_thread */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> check_infinite_requests<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_max_requests_per_child<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        signal_threads<span style='color:#808030; '>(</span>ST_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* wow! if you're executing this code, you may have set a record.</span>
<span style='color:#696969; '>         * either this child process has served over 2 billion requests, or</span>
<span style='color:#696969; '>         * you're running a threaded 2.0 on a 16 bit machine.  </span>
<span style='color:#696969; '>         *</span>
<span style='color:#696969; '>         * I'll buy pizza and beers at Apachecon for the first person to do</span>
<span style='color:#696969; '>         * the former without cheating (dorking with INT_MAX, or running with</span>
<span style='color:#696969; '>         * uncommitted performance patches, for example).    </span>
<span style='color:#696969; '>         *</span>
<span style='color:#696969; '>         * for the latter case, you probably deserve a beer too.   Greg Ames</span>
<span style='color:#696969; '>         */</span>
        requests_this_child <span style='color:#808030; '>=</span> INT_MAX<span style='color:#800080; '>;</span>  <span style='color:#696969; '>/* keep going */</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> unblock_signal<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> sig<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    sigset_t sig_mask<span style='color:#800080; '>;</span>
    sigemptyset<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>sig_mask<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    sigaddset<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>sig_mask<span style='color:#808030; '>,</span> sig<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>if</span><span style='color:#004a43; '> </span><span style='color:#004a43; '>defined</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>SIGPROCMASK_SETS_THREAD_MASK</span><span style='color:#808030; '>)</span>
    sigprocmask<span style='color:#808030; '>(</span>SIG_UNBLOCK<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sig_mask<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>else</span>
    pthread_sigmask<span style='color:#808030; '>(</span>SIG_UNBLOCK<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>sig_mask<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> dummy_signal_handler<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> sig<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#696969; '>/* XXX If specifying SIG_IGN is guaranteed to unblock a syscall,</span>
<span style='color:#696969; '>     *     then we don't need this goofy function.</span>
<span style='color:#696969; '>     */</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> apr_status_t push2worker<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>const</span> apr_pollfd_t <span style='color:#808030; '>*</span> pfd<span style='color:#808030; '>,</span>
                                apr_pollset_t <span style='color:#808030; '>*</span> pollset<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    listener_poll_type <span style='color:#808030; '>*</span>pt <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>listener_poll_type <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> pfd<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>client_data<span style='color:#800080; '>;</span>
    conn_state_t <span style='color:#808030; '>*</span>cs <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>conn_state_t <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>baton<span style='color:#800080; '>;</span>
    apr_status_t rc<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>status <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>status <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    rc <span style='color:#808030; '>=</span> apr_pollset_remove<span style='color:#808030; '>(</span>pollset<span style='color:#808030; '>,</span> pfd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* </span>
<span style='color:#696969; '>     * Some of the pollset backends, like KQueue or Epoll</span>
<span style='color:#696969; '>     * automagically remove the FD if the socket is closed,</span>
<span style='color:#696969; '>     * therefore, we can accept _SUCCESS or _NOTFOUND,</span>
<span style='color:#696969; '>     * and we still want to keep going</span>
<span style='color:#696969; '>     */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_NOTFOUND<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span> CONN_STATE_LINGER<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    rc <span style='color:#808030; '>=</span> ap_queue_push<span style='color:#808030; '>(</span>worker_queue<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>.</span>desc<span style='color:#808030; '>.</span>s<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* trash the connection; we couldn't queue the connected</span>
<span style='color:#696969; '>         * socket to a worker </span>
<span style='color:#696969; '>         */</span>
        apr_bucket_alloc_destroy<span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>bucket_alloc<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_socket_close<span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>.</span>desc<span style='color:#808030; '>.</span>s<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span>
                     ap_server_conf<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"push2worker: ap_queue_push failed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_pool_clear<span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_push_pool<span style='color:#808030; '>(</span>worker_queue_info<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> APR_SUCCESS<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>listener_thread<span style='color:#808030; '>(</span>apr_thread_t <span style='color:#808030; '>*</span> thd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    apr_status_t rc<span style='color:#800080; '>;</span>
    proc_info <span style='color:#808030; '>*</span>ti <span style='color:#808030; '>=</span> dummy<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> process_slot <span style='color:#808030; '>=</span> ti<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pid<span style='color:#800080; '>;</span>
    apr_pool_t <span style='color:#808030; '>*</span>tpool <span style='color:#808030; '>=</span> apr_thread_pool_get<span style='color:#808030; '>(</span>thd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>csd <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    apr_pool_t <span style='color:#808030; '>*</span>ptrans<span style='color:#800080; '>;</span>         <span style='color:#696969; '>/* Pool for per-transaction stuff */</span>
    ap_listen_rec <span style='color:#808030; '>*</span>lr<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> have_idle_worker <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    conn_state_t <span style='color:#808030; '>*</span>cs<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>const</span> apr_pollfd_t <span style='color:#808030; '>*</span>out_pfd<span style='color:#800080; '>;</span>
    apr_int32_t num <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    apr_time_t time_now <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    apr_interval_time_t timeout_interval<span style='color:#800080; '>;</span>
    apr_time_t timeout_time<span style='color:#800080; '>;</span>
    listener_poll_type <span style='color:#808030; '>*</span>pt<span style='color:#800080; '>;</span>
    free<span style='color:#808030; '>(</span>ti<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* We set this to force apr_pollset to wakeup if there hasn't been any IO</span>
<span style='color:#696969; '>     * on any of its sockets.  This allows sockets to have been added</span>
<span style='color:#696969; '>     * when no other keepalive operations where going on.</span>
<span style='color:#696969; '>     *   </span>
<span style='color:#696969; '>     * current value is 1 second</span>
<span style='color:#696969; '>     */</span>
    timeout_interval <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1000000</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* the following times out events that are really close in the future</span>
<span style='color:#696969; '>     *   to prevent extra poll calls</span>
<span style='color:#696969; '>     *   </span>
<span style='color:#696969; '>     * current value is .1 second</span>
<span style='color:#696969; '>     */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> TIMEOUT_FUDGE_FACTOR 100000</span>
    <span style='color:#696969; '>/* POLLSET_SCALE_FACTOR * ap_threads_per_child sets the size of</span>
<span style='color:#696969; '>     * the pollset.  I've seen 15 connections per active worker thread</span>
<span style='color:#696969; '>     * running SPECweb99. </span>
<span style='color:#696969; '>     * </span>
<span style='color:#696969; '>     * However, with the newer apr_pollset, this is the number of sockets that</span>
<span style='color:#696969; '>     * we will return to any *one* call to poll().  Therefore, there is no</span>
<span style='color:#696969; '>     * reason to make it more than ap_threads_per_child.</span>
<span style='color:#696969; '>     */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> POLLSET_SCALE_FACTOR 1</span>
    rc <span style='color:#808030; '>=</span> apr_thread_mutex_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>timeout_mutex<span style='color:#808030; '>,</span> APR_THREAD_MUTEX_DEFAULT<span style='color:#808030; '>,</span>
                                 tpool<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ERR<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"creation of the timeout mutex failed.  Attempting to "</span>
                     <span style='color:#0000e6; '>"shutdown process gracefully"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        signal_threads<span style='color:#808030; '>(</span>ST_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    APR_RING_INIT<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>timeout_head<span style='color:#808030; '>,</span> conn_state_t<span style='color:#808030; '>,</span> timeout_list<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* Create the main pollset */</span>
    rc <span style='color:#808030; '>=</span> apr_pollset_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>event_pollset<span style='color:#808030; '>,</span>
                            ap_threads_per_child <span style='color:#808030; '>*</span> POLLSET_SCALE_FACTOR<span style='color:#808030; '>,</span>
                            tpool<span style='color:#808030; '>,</span> APR_POLLSET_THREADSAFE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ERR<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"apr_pollset_create with Thread Safety failed.  Attempting to "</span>
                     <span style='color:#0000e6; '>"shutdown process gracefully"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        signal_threads<span style='color:#808030; '>(</span>ST_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>lr <span style='color:#808030; '>=</span> ap_listeners<span style='color:#800080; '>;</span> lr <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span> lr <span style='color:#808030; '>=</span> lr<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>next<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        apr_pollfd_t pfd <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span> <span style='color:#008c00; '>0</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
        pt <span style='color:#808030; '>=</span> apr_pcalloc<span style='color:#808030; '>(</span>tpool<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>pt<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        pfd<span style='color:#808030; '>.</span>desc_type <span style='color:#808030; '>=</span> APR_POLL_SOCKET<span style='color:#800080; '>;</span>
        pfd<span style='color:#808030; '>.</span>desc<span style='color:#808030; '>.</span>s <span style='color:#808030; '>=</span> lr<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>sd<span style='color:#800080; '>;</span>
        pfd<span style='color:#808030; '>.</span>reqevents <span style='color:#808030; '>=</span> APR_POLLIN<span style='color:#800080; '>;</span>
        pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>type <span style='color:#808030; '>=</span> PT_ACCEPT<span style='color:#800080; '>;</span>
        pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>baton <span style='color:#808030; '>=</span> lr<span style='color:#800080; '>;</span>
        pfd<span style='color:#808030; '>.</span>client_data <span style='color:#808030; '>=</span> pt<span style='color:#800080; '>;</span>
        apr_socket_opt_set<span style='color:#808030; '>(</span>pfd<span style='color:#808030; '>.</span>desc<span style='color:#808030; '>.</span>s<span style='color:#808030; '>,</span> APR_SO_NONBLOCK<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_pollset_add<span style='color:#808030; '>(</span>event_pollset<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>pfd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* Unblock the signal used to wake this thread up, and set a handler for</span>
<span style='color:#696969; '>     * it.</span>
<span style='color:#696969; '>     */</span>
    unblock_signal<span style='color:#808030; '>(</span>LISTENER_SIGNAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    apr_signal<span style='color:#808030; '>(</span>LISTENER_SIGNAL<span style='color:#808030; '>,</span> dummy_signal_handler<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>listener_may_exit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>requests_this_child <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            check_infinite_requests<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        rc <span style='color:#808030; '>=</span> apr_pollset_poll<span style='color:#808030; '>(</span>event_pollset<span style='color:#808030; '>,</span> timeout_interval<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>num<span style='color:#808030; '>,</span>
                              <span style='color:#808030; '>&amp;</span>out_pfd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>APR_STATUS_IS_EINTR<span style='color:#808030; '>(</span>rc<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>continue</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>APR_STATUS_IS_TIMEUP<span style='color:#808030; '>(</span>rc<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ERR<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"apr_pollset_poll failed.  Attempting to "</span>
                             <span style='color:#0000e6; '>"shutdown process gracefully"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                signal_threads<span style='color:#808030; '>(</span>ST_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>listener_may_exit<span style='color:#808030; '>)</span>
            <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span>num<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            pt <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>listener_poll_type <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> out_pfd<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>client_data<span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>type <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> PT_CSD<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* one of the sockets is readable */</span>
                cs <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>conn_state_t <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>baton<span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>switch</span> <span style='color:#808030; '>(</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>CONN_STATE_CHECK_REQUEST_LINE_READABLE</span><span style='color:#e34adc; '>:</span>
                    cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span> CONN_STATE_READ_REQUEST_LINE<span style='color:#800080; '>;</span>
                    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
<span style='color:#e34adc; '>                </span><span style='color:#800000; font-weight:bold; '>default</span><span style='color:#e34adc; '>:</span>
                    ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ERR<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span>
                                 ap_server_conf<span style='color:#808030; '>,</span>
                                 <span style='color:#0000e6; '>"event_loop: unexpected state </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span>
                                 cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    AP_DEBUG_ASSERT<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
                apr_thread_mutex_lock<span style='color:#808030; '>(</span>timeout_mutex<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                APR_RING_REMOVE<span style='color:#808030; '>(</span>cs<span style='color:#808030; '>,</span> timeout_list<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                apr_thread_mutex_unlock<span style='color:#808030; '>(</span>timeout_mutex<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                rc <span style='color:#808030; '>=</span> push2worker<span style='color:#808030; '>(</span>out_pfd<span style='color:#808030; '>,</span> event_pollset<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                    ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span>
                                 ap_server_conf<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"push2worker failed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* A Listener Socket is ready for an accept() */</span>
                apr_pool_t <span style='color:#808030; '>*</span>recycled_pool <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
                lr <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>ap_listen_rec <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> pt<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>baton<span style='color:#800080; '>;</span>
                ap_pop_pool<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>recycled_pool<span style='color:#808030; '>,</span> worker_queue_info<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>recycled_pool <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                    <span style='color:#696969; '>/* create a new transaction pool for each accepted socket */</span>
                    apr_allocator_t <span style='color:#808030; '>*</span>allocator<span style='color:#800080; '>;</span>
                    apr_allocator_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>allocator<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    apr_allocator_max_free_set<span style='color:#808030; '>(</span>allocator<span style='color:#808030; '>,</span>
                                               ap_max_mem_free<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    apr_pool_create_ex<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>ptrans<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> allocator<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    apr_allocator_owner_set<span style='color:#808030; '>(</span>allocator<span style='color:#808030; '>,</span> ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ptrans <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span>
                                     ap_server_conf<span style='color:#808030; '>,</span>
                                     <span style='color:#0000e6; '>"Failed to create transaction pool"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                        signal_threads<span style='color:#808030; '>(</span>ST_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
                    <span style='color:#800080; '>}</span>
                <span style='color:#800080; '>}</span>
                <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
                    ptrans <span style='color:#808030; '>=</span> recycled_pool<span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
                apr_pool_tag<span style='color:#808030; '>(</span>ptrans<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"transaction"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                rc <span style='color:#808030; '>=</span> lr<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>accept_func<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>csd<span style='color:#808030; '>,</span> lr<span style='color:#808030; '>,</span> ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#696969; '>/* later we trash rv and rely on csd to indicate success/failure */</span>
                AP_DEBUG_ASSERT<span style='color:#808030; '>(</span>rc <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> APR_SUCCESS <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#808030; '>!</span>csd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> APR_EGENERAL<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                    <span style='color:#696969; '>/* E[NM]FILE, ENOMEM, etc */</span>
                    resource_shortage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
                    signal_threads<span style='color:#808030; '>(</span>ST_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>csd <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                    rc <span style='color:#808030; '>=</span> ap_queue_push<span style='color:#808030; '>(</span>worker_queue<span style='color:#808030; '>,</span> csd<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                        <span style='color:#696969; '>/* trash the connection; we couldn't queue the connected</span>
<span style='color:#696969; '>                         * socket to a worker </span>
<span style='color:#696969; '>                         */</span>
                        apr_socket_close<span style='color:#808030; '>(</span>csd<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rc<span style='color:#808030; '>,</span>
                                     ap_server_conf<span style='color:#808030; '>,</span>
                                     <span style='color:#0000e6; '>"ap_queue_push failed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                        apr_pool_clear<span style='color:#808030; '>(</span>ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                        ap_push_pool<span style='color:#808030; '>(</span>worker_queue_info<span style='color:#808030; '>,</span> ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    <span style='color:#800080; '>}</span>
                    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
                        have_idle_worker <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
                    <span style='color:#800080; '>}</span>
                <span style='color:#800080; '>}</span>
                <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
                    apr_pool_clear<span style='color:#808030; '>(</span>ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    ap_push_pool<span style='color:#808030; '>(</span>worker_queue_info<span style='color:#808030; '>,</span> ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
            <span style='color:#800080; '>}</span>               <span style='color:#696969; '>/* if:else on pt->type */</span>
            out_pfd<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
            num<span style='color:#808030; '>-</span><span style='color:#808030; '>-</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>                   <span style='color:#696969; '>/* while for processing poll */</span>
        <span style='color:#696969; '>/* XXX possible optimization: stash the current time for use as</span>
<span style='color:#696969; '>         * r->request_time for new requests</span>
<span style='color:#696969; '>         */</span>
        time_now <span style='color:#808030; '>=</span> apr_time_now<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* handle timed out sockets */</span>
        apr_thread_mutex_lock<span style='color:#808030; '>(</span>timeout_mutex<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        cs <span style='color:#808030; '>=</span> APR_RING_FIRST<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>timeout_head<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        timeout_time <span style='color:#808030; '>=</span> time_now <span style='color:#808030; '>+</span> TIMEOUT_FUDGE_FACTOR<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>APR_RING_EMPTY<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>timeout_head<span style='color:#808030; '>,</span> conn_state_t<span style='color:#808030; '>,</span> timeout_list<span style='color:#808030; '>)</span>
               <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>expiration_time <span style='color:#808030; '>&lt;</span> timeout_time<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>state <span style='color:#808030; '>=</span> CONN_STATE_LINGER<span style='color:#800080; '>;</span>
            APR_RING_REMOVE<span style='color:#808030; '>(</span>cs<span style='color:#808030; '>,</span> timeout_list<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            rc <span style='color:#808030; '>=</span> push2worker<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>cs<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pfd<span style='color:#808030; '>,</span> event_pollset<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rc <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            cs <span style='color:#808030; '>=</span> APR_RING_FIRST<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>timeout_head<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        apr_thread_mutex_unlock<span style='color:#808030; '>(</span>timeout_mutex<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>     <span style='color:#696969; '>/* listener main loop */</span>
    ap_queue_term<span style='color:#808030; '>(</span>worker_queue<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    dying <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>process_slot<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>quiescing <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* wake up the main thread */</span>
    kill<span style='color:#808030; '>(</span>ap_my_pid<span style='color:#808030; '>,</span> SIGTERM<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    apr_thread_exit<span style='color:#808030; '>(</span>thd<span style='color:#808030; '>,</span> APR_SUCCESS<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/* XXX For ungraceful termination/restart, we definitely don't want to</span>
<span style='color:#696969; '> *     wait for active connections to finish but we may want to wait</span>
<span style='color:#696969; '> *     for idle workers to get out of the queue code and release mutexes,</span>
<span style='color:#696969; '> *     since those mutexes are cleaned up pretty soon and some systems</span>
<span style='color:#696969; '> *     may not react favorably (i.e., segfault) if operations are attempted</span>
<span style='color:#696969; '> *     on cleaned-up mutexes.</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>APR_THREAD_FUNC worker_thread<span style='color:#808030; '>(</span>apr_thread_t <span style='color:#808030; '>*</span> thd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    proc_info <span style='color:#808030; '>*</span>ti <span style='color:#808030; '>=</span> dummy<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> process_slot <span style='color:#808030; '>=</span> ti<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pid<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> thread_slot <span style='color:#808030; '>=</span> ti<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>tid<span style='color:#800080; '>;</span>
    apr_socket_t <span style='color:#808030; '>*</span>csd <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    conn_state_t <span style='color:#808030; '>*</span>cs<span style='color:#800080; '>;</span>
    apr_pool_t <span style='color:#808030; '>*</span>ptrans<span style='color:#800080; '>;</span>         <span style='color:#696969; '>/* Pool for per-transaction stuff */</span>
    apr_status_t rv<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> is_idle <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    free<span style='color:#808030; '>(</span>ti<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    ap_update_child_status_from_indexes<span style='color:#808030; '>(</span>process_slot<span style='color:#808030; '>,</span> thread_slot<span style='color:#808030; '>,</span>
                                        SERVER_STARTING<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>workers_may_exit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>is_idle<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            rv <span style='color:#808030; '>=</span> ap_queue_info_set_idle<span style='color:#808030; '>(</span>worker_queue_info<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_EMERG<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"ap_queue_info_set_idle failed. Attempting to "</span>
                             <span style='color:#0000e6; '>"shutdown process gracefully."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                signal_threads<span style='color:#808030; '>(</span>ST_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            is_idle <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        ap_update_child_status_from_indexes<span style='color:#808030; '>(</span>process_slot<span style='color:#808030; '>,</span> thread_slot<span style='color:#808030; '>,</span>
                                            SERVER_READY<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#e34adc; '>      worker_pop:</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>workers_may_exit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        rv <span style='color:#808030; '>=</span> ap_queue_pop<span style='color:#808030; '>(</span>worker_queue<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>csd<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>cs<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>ptrans<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#696969; '>/* We get APR_EOF during a graceful shutdown once all the connections</span>
<span style='color:#696969; '>             * accepted by this server process have been handled.</span>
<span style='color:#696969; '>             */</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>APR_STATUS_IS_EOF<span style='color:#808030; '>(</span>rv<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#696969; '>/* We get APR_EINTR whenever ap_queue_pop() has been interrupted</span>
<span style='color:#696969; '>             * from an explicit call to ap_queue_interrupt_all(). This allows</span>
<span style='color:#696969; '>             * us to unblock threads stuck in ap_queue_pop() when a shutdown</span>
<span style='color:#696969; '>             * is pending.</span>
<span style='color:#696969; '>             *</span>
<span style='color:#696969; '>             * If workers_may_exit is set and this is ungraceful termination/</span>
<span style='color:#696969; '>             * restart, we are bound to get an error on some systems (e.g.,</span>
<span style='color:#696969; '>             * AIX, which sanity-checks mutex operations) since the queue</span>
<span style='color:#696969; '>             * may have already been cleaned up.  Don't log the "error" if</span>
<span style='color:#696969; '>             * workers_may_exit is set.</span>
<span style='color:#696969; '>             */</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>APR_STATUS_IS_EINTR<span style='color:#808030; '>(</span>rv<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#008484; '>goto</span> <span style='color:#e34adc; '>worker_pop</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#696969; '>/* We got some other error. */</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>workers_may_exit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"ap_queue_pop failed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>continue</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        is_idle <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        worker_sockets<span style='color:#808030; '>[</span>thread_slot<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> csd<span style='color:#800080; '>;</span>
        rv <span style='color:#808030; '>=</span> process_socket<span style='color:#808030; '>(</span>ptrans<span style='color:#808030; '>,</span> csd<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>,</span> process_slot<span style='color:#808030; '>,</span> thread_slot<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>rv<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            requests_this_child<span style='color:#808030; '>-</span><span style='color:#808030; '>-</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        worker_sockets<span style='color:#808030; '>[</span>thread_slot<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    ap_update_child_status_from_indexes<span style='color:#808030; '>(</span>process_slot<span style='color:#808030; '>,</span> thread_slot<span style='color:#808030; '>,</span>
                                        <span style='color:#808030; '>(</span>dying<span style='color:#808030; '>)</span> <span style='color:#800080; '>?</span> SERVER_DEAD <span style='color:#800080; '>:</span>
                                        SERVER_GRACEFUL<span style='color:#808030; '>,</span>
                                        <span style='color:#808030; '>(</span>request_rec <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    apr_thread_exit<span style='color:#808030; '>(</span>thd<span style='color:#808030; '>,</span> APR_SUCCESS<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> check_signal<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> signum<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>switch</span> <span style='color:#808030; '>(</span>signum<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>SIGTERM</span><span style='color:#e34adc; '>:</span>
    <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>SIGINT</span><span style='color:#e34adc; '>:</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> create_listener_thread<span style='color:#808030; '>(</span>thread_starter <span style='color:#808030; '>*</span> ts<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> my_child_num <span style='color:#808030; '>=</span> ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>child_num_arg<span style='color:#800080; '>;</span>
    apr_threadattr_t <span style='color:#808030; '>*</span>thread_attr <span style='color:#808030; '>=</span> ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>threadattr<span style='color:#800080; '>;</span>
    proc_info <span style='color:#808030; '>*</span>my_info<span style='color:#800080; '>;</span>
    apr_status_t rv<span style='color:#800080; '>;</span>
    my_info <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>proc_info <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> malloc<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>proc_info<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    my_info<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pid <span style='color:#808030; '>=</span> my_child_num<span style='color:#800080; '>;</span>
    my_info<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>tid <span style='color:#808030; '>=</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>          <span style='color:#696969; '>/* listener thread doesn't have a thread slot */</span>
    my_info<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>sd <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    rv <span style='color:#808030; '>=</span> apr_thread_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>listener<span style='color:#808030; '>,</span> thread_attr<span style='color:#808030; '>,</span> listener_thread<span style='color:#808030; '>,</span>
                           my_info<span style='color:#808030; '>,</span> pchild<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"apr_thread_create: unable to create listener thread"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* In case system resources are maxxed out, we don't want</span>
<span style='color:#696969; '>         * Apache running away with the CPU trying to fork over and</span>
<span style='color:#696969; '>         * over and over again if we exit.</span>
<span style='color:#696969; '>         * XXX Jeff doesn't see how Apache is going to try to fork again since</span>
<span style='color:#696969; '>         * the exit code is APEXIT_CHILDFATAL</span>
<span style='color:#696969; '>         */</span>
        apr_sleep<span style='color:#808030; '>(</span>apr_time_from_sec<span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    apr_os_thread_get<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>listener_os_thread<span style='color:#808030; '>,</span> ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>listener<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/* XXX under some circumstances not understood, children can get stuck</span>
<span style='color:#696969; '> *     in start_threads forever trying to take over slots which will</span>
<span style='color:#696969; '> *     never be cleaned up; for now there is an APLOG_DEBUG message issued</span>
<span style='color:#696969; '> *     every so often when this condition occurs</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>APR_THREAD_FUNC start_threads<span style='color:#808030; '>(</span>apr_thread_t <span style='color:#808030; '>*</span> thd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    thread_starter <span style='color:#808030; '>*</span>ts <span style='color:#808030; '>=</span> dummy<span style='color:#800080; '>;</span>
    apr_thread_t <span style='color:#808030; '>*</span><span style='color:#808030; '>*</span>threads <span style='color:#808030; '>=</span> ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>threads<span style='color:#800080; '>;</span>
    apr_threadattr_t <span style='color:#808030; '>*</span>thread_attr <span style='color:#808030; '>=</span> ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>threadattr<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> child_num_arg <span style='color:#808030; '>=</span> ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>child_num_arg<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> my_child_num <span style='color:#808030; '>=</span> child_num_arg<span style='color:#800080; '>;</span>
    proc_info <span style='color:#808030; '>*</span>my_info<span style='color:#800080; '>;</span>
    apr_status_t rv<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> threads_created <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> listener_started <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> loops<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> prev_threads_created<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* We must create the fd queues before we start up the listener</span>
<span style='color:#696969; '>     * and worker threads. */</span>
    worker_queue <span style='color:#808030; '>=</span> apr_pcalloc<span style='color:#808030; '>(</span>pchild<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>worker_queue<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    rv <span style='color:#808030; '>=</span> ap_queue_init<span style='color:#808030; '>(</span>worker_queue<span style='color:#808030; '>,</span> ap_threads_per_child <span style='color:#808030; '>*</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span> pchild<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"ap_queue_init() failed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    rv <span style='color:#808030; '>=</span> ap_queue_info_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>worker_queue_info<span style='color:#808030; '>,</span> pchild<span style='color:#808030; '>,</span>
                              ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"ap_queue_info_create() failed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    worker_sockets <span style='color:#808030; '>=</span> apr_pcalloc<span style='color:#808030; '>(</span>pchild<span style='color:#808030; '>,</span> ap_threads_per_child
                                 <span style='color:#808030; '>*</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>apr_socket_t <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    loops <span style='color:#808030; '>=</span> prev_threads_created <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* ap_threads_per_child does not include the listener thread */</span>
        <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> ap_threads_per_child<span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>int</span> status <span style='color:#808030; '>=</span>
                ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>servers<span style='color:#808030; '>[</span>child_num_arg<span style='color:#808030; '>]</span><span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>status<span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>status <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> SERVER_GRACEFUL <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> status <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> SERVER_DEAD<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>continue</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            my_info <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>proc_info <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> malloc<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>proc_info<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>my_info <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"malloc: out of memory"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            my_info<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pid <span style='color:#808030; '>=</span> my_child_num<span style='color:#800080; '>;</span>
            my_info<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>tid <span style='color:#808030; '>=</span> i<span style='color:#800080; '>;</span>
            my_info<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>sd <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>/* We are creating threads right now */</span>
            ap_update_child_status_from_indexes<span style='color:#808030; '>(</span>my_child_num<span style='color:#808030; '>,</span> i<span style='color:#808030; '>,</span>
                                                SERVER_STARTING<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>/* We let each thread update its own scoreboard entry.  This is</span>
<span style='color:#696969; '>             * done because it lets us deal with tid better.</span>
<span style='color:#696969; '>             */</span>
            rv <span style='color:#808030; '>=</span> apr_thread_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>threads<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> thread_attr<span style='color:#808030; '>,</span>
                                   worker_thread<span style='color:#808030; '>,</span> my_info<span style='color:#808030; '>,</span> pchild<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"apr_thread_create: unable to create worker thread"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#696969; '>/* In case system resources are maxxed out, we don't want</span>
<span style='color:#696969; '>                   Apache running away with the CPU trying to fork over and</span>
<span style='color:#696969; '>                   over and over again if we exit. */</span>
                apr_sleep<span style='color:#808030; '>(</span>apr_time_from_sec<span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            threads_created<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#696969; '>/* Start the listener only when there are workers available */</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>listener_started <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> threads_created<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            create_listener_thread<span style='color:#808030; '>(</span>ts<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            listener_started <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>start_thread_may_exit <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> threads_created <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> ap_threads_per_child<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#696969; '>/* wait for previous generation to clean up an entry */</span>
        apr_sleep<span style='color:#808030; '>(</span>apr_time_from_sec<span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>loops<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>loops <span style='color:#808030; '>%</span> <span style='color:#008c00; '>120</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '>/* every couple of minutes */</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>prev_threads_created <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> threads_created<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_DEBUG<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"child %"</span> APR_PID_T_FMT <span style='color:#0000e6; '>" isn't taking over "</span>
                             <span style='color:#0000e6; '>"slots very quickly (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>)"</span><span style='color:#808030; '>,</span>
                             ap_my_pid<span style='color:#808030; '>,</span> threads_created<span style='color:#808030; '>,</span>
                             ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            prev_threads_created <span style='color:#808030; '>=</span> threads_created<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* What state should this child_main process be listed as in the </span>
<span style='color:#696969; '>     * scoreboard...?</span>
<span style='color:#696969; '>     *  ap_update_child_status_from_indexes(my_child_num, i, SERVER_STARTING, </span>
<span style='color:#696969; '>     *                                      (request_rec *) NULL);</span>
<span style='color:#696969; '>     * </span>
<span style='color:#696969; '>     *  This state should be listed separately in the scoreboard, in some kind</span>
<span style='color:#696969; '>     *  of process_status, not mixed in with the worker threads' status.   </span>
<span style='color:#696969; '>     *  "life_status" is almost right, but it's in the worker's structure, and </span>
<span style='color:#696969; '>     *  the name could be clearer.   gla</span>
<span style='color:#696969; '>     */</span>
    apr_thread_exit<span style='color:#808030; '>(</span>thd<span style='color:#808030; '>,</span> APR_SUCCESS<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> join_workers<span style='color:#808030; '>(</span>apr_thread_t <span style='color:#808030; '>*</span> listener<span style='color:#808030; '>,</span> apr_thread_t <span style='color:#808030; '>*</span><span style='color:#808030; '>*</span> threads<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#800080; '>;</span>
    apr_status_t rv<span style='color:#808030; '>,</span> thread_rv<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>listener<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>int</span> iter<span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* deal with a rare timing window which affects waking up the</span>
<span style='color:#696969; '>         * listener thread...  if the signal sent to the listener thread</span>
<span style='color:#696969; '>         * is delivered between the time it verifies that the</span>
<span style='color:#696969; '>         * listener_may_exit flag is clear and the time it enters a</span>
<span style='color:#696969; '>         * blocking syscall, the signal didn't do any good...  work around</span>
<span style='color:#696969; '>         * that by sleeping briefly and sending it again</span>
<span style='color:#696969; '>         */</span>
        iter <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span>iter <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>10</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> HAVE_PTHREAD_KILL</span>
               pthread_kill<span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>listener_os_thread<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>else</span>
               kill<span style='color:#808030; '>(</span>ap_my_pid<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
               <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#696969; '>/* listener not dead yet */</span>
            apr_sleep<span style='color:#808030; '>(</span>apr_time_make<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>500000</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            wakeup_listener<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>iter<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>iter <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_DEBUG<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                         <span style='color:#0000e6; '>"the listener thread didn't exit"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
            rv <span style='color:#808030; '>=</span> apr_thread_join<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>thread_rv<span style='color:#808030; '>,</span> listener<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"apr_thread_join: unable to join listener thread"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> ap_threads_per_child<span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>threads<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>       <span style='color:#696969; '>/* if we ever created this thread */</span>
            rv <span style='color:#808030; '>=</span> apr_thread_join<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>thread_rv<span style='color:#808030; '>,</span> threads<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"apr_thread_join: unable to join worker "</span>
                             <span style='color:#0000e6; '>"thread </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span> i<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> join_start_thread<span style='color:#808030; '>(</span>apr_thread_t <span style='color:#808030; '>*</span> start_thread_id<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    apr_status_t rv<span style='color:#808030; '>,</span> thread_rv<span style='color:#800080; '>;</span>
    start_thread_may_exit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>  <span style='color:#696969; '>/* tell it to give up in case it is still </span>
<span style='color:#696969; '>                                 * trying to take over slots from a </span>
<span style='color:#696969; '>                                 * previous generation</span>
<span style='color:#696969; '>                                 */</span>
    rv <span style='color:#808030; '>=</span> apr_thread_join<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>thread_rv<span style='color:#808030; '>,</span> start_thread_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"apr_thread_join: unable to join the start "</span> <span style='color:#0000e6; '>"thread"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> child_main<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> child_num_arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    apr_thread_t <span style='color:#808030; '>*</span><span style='color:#808030; '>*</span>threads<span style='color:#800080; '>;</span>
    apr_status_t rv<span style='color:#800080; '>;</span>
    thread_starter <span style='color:#808030; '>*</span>ts<span style='color:#800080; '>;</span>
    apr_threadattr_t <span style='color:#808030; '>*</span>thread_attr<span style='color:#800080; '>;</span>
    apr_thread_t <span style='color:#808030; '>*</span>start_thread_id<span style='color:#800080; '>;</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STARTING<span style='color:#800080; '>;</span>       <span style='color:#696969; '>/* for benefit of any hooks that run as this</span>
<span style='color:#696969; '>                                         * child initializes</span>
<span style='color:#696969; '>                                         */</span>
    ap_my_pid <span style='color:#808030; '>=</span> getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    ap_fatal_signal_child_setup<span style='color:#808030; '>(</span>ap_server_conf<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    apr_pool_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>pchild<span style='color:#808030; '>,</span> pconf<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/*stuff to do before we switch id's, so we have permissions. */</span>
    ap_reopen_scoreboard<span style='color:#808030; '>(</span>pchild<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>unixd_setup_child<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    ap_run_child_init<span style='color:#808030; '>(</span>pchild<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* done with init critical section */</span>
    <span style='color:#696969; '>/* Just use the standard apr_setup_signal_thread to block all signals</span>
<span style='color:#696969; '>     * from being received.  The child processes no longer use signals for</span>
<span style='color:#696969; '>     * any communication with the parent process.</span>
<span style='color:#696969; '>     */</span>
    rv <span style='color:#808030; '>=</span> apr_setup_signal_thread<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_EMERG<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"Couldn't initialize signal thread"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_max_requests_per_child<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        requests_this_child <span style='color:#808030; '>=</span> ap_max_requests_per_child<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* coding a value of zero means infinity */</span>
        requests_this_child <span style='color:#808030; '>=</span> INT_MAX<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* Setup worker threads */</span>
    <span style='color:#696969; '>/* clear the storage; we may not create all our threads immediately, </span>
<span style='color:#696969; '>     * and we want a 0 entry to indicate a thread which was not created</span>
<span style='color:#696969; '>     */</span>
    threads <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>apr_thread_t <span style='color:#808030; '>*</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> calloc<span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
                                       <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>apr_thread_t <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span>
                                       ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>threads <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"malloc: out of memory"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    ts <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>thread_starter <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> apr_palloc<span style='color:#808030; '>(</span>pchild<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>ts<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    apr_threadattr_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>thread_attr<span style='color:#808030; '>,</span> pchild<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* 0 means PTHREAD_CREATE_JOINABLE */</span>
    apr_threadattr_detach_set<span style='color:#808030; '>(</span>thread_attr<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_thread_stacksize <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        apr_threadattr_stacksize_set<span style='color:#808030; '>(</span>thread_attr<span style='color:#808030; '>,</span> ap_thread_stacksize<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>threads <span style='color:#808030; '>=</span> threads<span style='color:#800080; '>;</span>
    ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>listener <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>child_num_arg <span style='color:#808030; '>=</span> child_num_arg<span style='color:#800080; '>;</span>
    ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>threadattr <span style='color:#808030; '>=</span> thread_attr<span style='color:#800080; '>;</span>
    rv <span style='color:#808030; '>=</span> apr_thread_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>start_thread_id<span style='color:#808030; '>,</span> thread_attr<span style='color:#808030; '>,</span> start_threads<span style='color:#808030; '>,</span>
                           ts<span style='color:#808030; '>,</span> pchild<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"apr_thread_create: unable to create worker thread"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* In case system resources are maxxed out, we don't want</span>
<span style='color:#696969; '>           Apache running away with the CPU trying to fork over and</span>
<span style='color:#696969; '>           over and over again if we exit. */</span>
        apr_sleep<span style='color:#808030; '>(</span>apr_time_from_sec<span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        clean_child_exit<span style='color:#808030; '>(</span>APEXIT_CHILDFATAL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_RUNNING<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* If we are only running in one_process mode, we will want to</span>
<span style='color:#696969; '>     * still handle signals. */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>one_process<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* Block until we get a terminating signal. */</span>
        apr_signal_thread<span style='color:#808030; '>(</span>check_signal<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* make sure the start thread has finished; signal_threads() </span>
<span style='color:#696969; '>         * and join_workers() depend on that</span>
<span style='color:#696969; '>         */</span>
        <span style='color:#696969; '>/* XXX join_start_thread() won't be awakened if one of our</span>
<span style='color:#696969; '>         *     threads encounters a critical error and attempts to</span>
<span style='color:#696969; '>         *     shutdown this child</span>
<span style='color:#696969; '>         */</span>
        join_start_thread<span style='color:#808030; '>(</span>start_thread_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        signal_threads<span style='color:#808030; '>(</span>ST_UNGRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>  <span style='color:#696969; '>/* helps us terminate a little more</span>
<span style='color:#696969; '>                                         * quickly than the dispatch of the signal thread</span>
<span style='color:#696969; '>                                         * beats the Pipe of Death and the browsers</span>
<span style='color:#696969; '>                                         */</span>
        <span style='color:#696969; '>/* A terminating signal was received. Now join each of the</span>
<span style='color:#696969; '>         * workers to clean them up.</span>
<span style='color:#696969; '>         *   If the worker already exited, then the join frees</span>
<span style='color:#696969; '>         *   their resources and returns.</span>
<span style='color:#696969; '>         *   If the worker hasn't exited, then this blocks until</span>
<span style='color:#696969; '>         *   they have (then cleans up).</span>
<span style='color:#696969; '>         */</span>
        join_workers<span style='color:#808030; '>(</span>ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>listener<span style='color:#808030; '>,</span> threads<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>                      <span style='color:#696969; '>/* !one_process */</span>
        <span style='color:#696969; '>/* remove SIGTERM from the set of blocked signals...  if one of</span>
<span style='color:#696969; '>         * the other threads in the process needs to take us down</span>
<span style='color:#696969; '>         * (e.g., for MaxRequestsPerChild) it will send us SIGTERM</span>
<span style='color:#696969; '>         */</span>
        unblock_signal<span style='color:#808030; '>(</span>SIGTERM<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_signal<span style='color:#808030; '>(</span>SIGTERM<span style='color:#808030; '>,</span> dummy_signal_handler<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* Watch for any messages from the parent over the POD */</span>
        <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            rv <span style='color:#808030; '>=</span> ap_mpm_pod_check<span style='color:#808030; '>(</span>pod<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> AP_NORESTART<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* see if termination was triggered while we slept */</span>
                <span style='color:#800000; font-weight:bold; '>switch</span> <span style='color:#808030; '>(</span>terminate_mode<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>ST_GRACEFUL</span><span style='color:#e34adc; '>:</span>
                    rv <span style='color:#808030; '>=</span> AP_GRACEFUL<span style='color:#800080; '>;</span>
                    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>case </span><span style='color:#7d0045; '>ST_UNGRACEFUL</span><span style='color:#e34adc; '>:</span>
                    rv <span style='color:#808030; '>=</span> AP_RESTART<span style='color:#800080; '>;</span>
                    <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> AP_GRACEFUL <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> rv <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> AP_RESTART<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* make sure the start thread has finished; </span>
<span style='color:#696969; '>                 * signal_threads() and join_workers depend on that</span>
<span style='color:#696969; '>                 */</span>
                join_start_thread<span style='color:#808030; '>(</span>start_thread_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                signal_threads<span style='color:#808030; '>(</span>rv <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span>
                               AP_GRACEFUL <span style='color:#800080; '>?</span> ST_GRACEFUL <span style='color:#800080; '>:</span> ST_UNGRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#696969; '>/* A terminating signal was received. Now join each of the</span>
<span style='color:#696969; '>         * workers to clean them up.</span>
<span style='color:#696969; '>         *   If the worker already exited, then the join frees</span>
<span style='color:#696969; '>         *   their resources and returns.</span>
<span style='color:#696969; '>         *   If the worker hasn't exited, then this blocks until</span>
<span style='color:#696969; '>         *   they have (then cleans up).</span>
<span style='color:#696969; '>         */</span>
        join_workers<span style='color:#808030; '>(</span>ts<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>listener<span style='color:#808030; '>,</span> threads<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    free<span style='color:#808030; '>(</span>threads<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    clean_child_exit<span style='color:#808030; '>(</span>resource_shortage <span style='color:#800080; '>?</span> APEXIT_CHILDSICK <span style='color:#800080; '>:</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> make_child<span style='color:#808030; '>(</span>server_rec <span style='color:#808030; '>*</span> s<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>int</span> slot<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> pid<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>slot <span style='color:#808030; '>+</span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>></span> ap_max_daemons_limit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_max_daemons_limit <span style='color:#808030; '>=</span> slot <span style='color:#808030; '>+</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>one_process<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        set_signals<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>slot<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>pid <span style='color:#808030; '>=</span> getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        child_main<span style='color:#808030; '>(</span>slot<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>pid <span style='color:#808030; '>=</span> fork<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ERR<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span> s<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"fork: Unable to fork new process"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* fork didn't succeed. </span><span style='color:#ffffff; background:#808000; '>Fix the scoreboard or else</span><span style='color:#696969; '></span>
<span style='color:#696969; '>         * it will say SERVER_STARTING forever and ever</span>
<span style='color:#696969; '>         */</span>
        ap_update_child_status_from_indexes<span style='color:#808030; '>(</span>slot<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> SERVER_DEAD<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* In case system resources are maxxed out, we don't want</span>
<span style='color:#696969; '>           Apache running away with the CPU trying to fork over and</span>
<span style='color:#696969; '>           over and over again. */</span>
        apr_sleep<span style='color:#808030; '>(</span>apr_time_from_sec<span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>pid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> HAVE_BINDPROCESSOR</span>
        <span style='color:#696969; '>/* By default, AIX binds to a single processor.  This bit unbinds</span>
<span style='color:#696969; '>         * children which will then bind to another CPU.</span>
<span style='color:#696969; '>         */</span>
        <span style='color:#800000; font-weight:bold; '>int</span> status <span style='color:#808030; '>=</span> bindprocessor<span style='color:#808030; '>(</span>BINDPROCESS<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span> getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
                                   PROCESSOR_CLASS_ANY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>status <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> OK<span style='color:#808030; '>)</span>
            ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> errno<span style='color:#808030; '>,</span>
                         ap_server_conf<span style='color:#808030; '>,</span>
                         <span style='color:#0000e6; '>"processor unbind failed </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span> status<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
        RAISE_SIGSTOP<span style='color:#808030; '>(</span>MAKE_CHILD<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        apr_signal<span style='color:#808030; '>(</span>SIGTERM<span style='color:#808030; '>,</span> just_die<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        child_main<span style='color:#808030; '>(</span>slot<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        clean_child_exit<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* else */</span>
    ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>slot<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>quiescing <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>slot<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>pid <span style='color:#808030; '>=</span> pid<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/* start up a bunch of children */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> startup_children<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> number_to_start<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> number_to_start <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> i <span style='color:#808030; '>&lt;</span> ap_daemons_limit<span style='color:#800080; '>;</span> <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>i<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>pid <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>continue</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>make_child<span style='color:#808030; '>(</span>ap_server_conf<span style='color:#808030; '>,</span> i<span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#808030; '>-</span><span style='color:#808030; '>-</span>number_to_start<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/*</span>
<span style='color:#696969; '> * idle_spawn_rate is the number of children that will be spawned on the</span>
<span style='color:#696969; '> * next maintenance cycle if there aren't enough idle servers.  It is</span>
<span style='color:#696969; '> * doubled up to MAX_SPAWN_RATE, and reset only when a cycle goes by</span>
<span style='color:#696969; '> * without the need to spawn.</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> idle_spawn_rate <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifndef</span><span style='color:#004a43; '> MAX_SPAWN_RATE</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> MAX_SPAWN_RATE        </span><span style='color:#808030; '>(</span><span style='color:#004a43; '>32</span><span style='color:#808030; '>)</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> hold_off_on_exponential_spawning<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> perform_idle_server_maintenance<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#808030; '>,</span> j<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> idle_thread_count<span style='color:#800080; '>;</span>
    worker_score <span style='color:#808030; '>*</span>ws<span style='color:#800080; '>;</span>
    process_score <span style='color:#808030; '>*</span>ps<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> free_length<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> totally_free_length <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> free_slots<span style='color:#808030; '>[</span>MAX_SPAWN_RATE<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> last_non_dead<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> total_non_dead<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* initialize the free_list */</span>
    free_length <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    idle_thread_count <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    last_non_dead <span style='color:#808030; '>=</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    total_non_dead <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> ap_daemons_limit<span style='color:#800080; '>;</span> <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>i<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* Initialization to satisfy the compiler. It doesn't know</span>
<span style='color:#696969; '>         * that ap_threads_per_child is always > 0 */</span>
        <span style='color:#800000; font-weight:bold; '>int</span> status <span style='color:#808030; '>=</span> SERVER_DEAD<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>int</span> any_dying_threads <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>int</span> any_dead_threads <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>int</span> all_dead_threads <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> ap_max_daemons_limit
            <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> totally_free_length <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> idle_spawn_rate<span style='color:#808030; '>)</span>
            <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
        ps <span style='color:#808030; '>=</span> <span style='color:#808030; '>&amp;</span>ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>j <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> j <span style='color:#808030; '>&lt;</span> ap_threads_per_child<span style='color:#800080; '>;</span> j<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            ws <span style='color:#808030; '>=</span> <span style='color:#808030; '>&amp;</span>ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>servers<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
            status <span style='color:#808030; '>=</span> ws<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>status<span style='color:#800080; '>;</span>
            <span style='color:#696969; '>/* XXX any_dying_threads is probably no longer needed    GLA */</span>
            any_dying_threads <span style='color:#808030; '>=</span> any_dying_threads <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span>
                <span style='color:#808030; '>(</span>status <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> SERVER_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            any_dead_threads <span style='color:#808030; '>=</span> any_dead_threads <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#808030; '>(</span>status <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> SERVER_DEAD<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            all_dead_threads <span style='color:#808030; '>=</span> all_dead_threads <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
                <span style='color:#808030; '>(</span>status <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> SERVER_DEAD <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> status <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> SERVER_GRACEFUL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>/* We consider a starting server as idle because we started it</span>
<span style='color:#696969; '>             * at least a cycle ago, and if it still hasn't finished starting</span>
<span style='color:#696969; '>             * then we're just going to swamp things worse by forking more.</span>
<span style='color:#696969; '>             * So we hopefully won't need to fork more if we count it.</span>
<span style='color:#696969; '>             * This depends on the ordering of SERVER_READY and SERVER_STARTING.</span>
<span style='color:#696969; '>             */</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>status <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> SERVER_READY <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> status <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> SERVER_DEAD <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
                <span style='color:#808030; '>!</span>ps<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>quiescing <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> ps<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>generation <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> ap_my_generation <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
                <span style='color:#696969; '>/* XXX the following shouldn't be necessary if we clean up </span>
<span style='color:#696969; '>                 *     properly after seg faults, but we're not yet    GLA </span>
<span style='color:#696969; '>                 */</span>
                ps<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pid <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>idle_thread_count<span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>any_dead_threads 
            <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> totally_free_length <span style='color:#808030; '>&lt;</span> idle_spawn_rate 
            <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> free_length <span style='color:#808030; '>&lt;</span> MAX_SPAWN_RATE 
            <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>ps<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pid      <span style='color:#696969; '>/* no process in the slot */</span>
                  <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> ps<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>quiescing<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>  <span style='color:#696969; '>/* or at least one is going away */</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>all_dead_threads<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* great! we prefer these, because the new process can</span>
<span style='color:#696969; '>                 * start more threads sooner.  So prioritize this slot </span>
<span style='color:#696969; '>                 * by putting it ahead of any slots with active threads.</span>
<span style='color:#696969; '>                 *</span>
<span style='color:#696969; '>                 * first, make room by moving a slot that's potentially still</span>
<span style='color:#696969; '>                 * in use to the end of the array</span>
<span style='color:#696969; '>                 */</span>
                free_slots<span style='color:#808030; '>[</span>free_length<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> free_slots<span style='color:#808030; '>[</span>totally_free_length<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
                free_slots<span style='color:#808030; '>[</span>totally_free_length<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> i<span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* slot is still in use - back of the bus</span>
<span style='color:#696969; '>                 */</span>
                free_slots<span style='color:#808030; '>[</span>free_length<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> i<span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>free_length<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#696969; '>/* XXX if (!ps->quiescing)     is probably more reliable  GLA */</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>any_dying_threads<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            last_non_dead <span style='color:#808030; '>=</span> i<span style='color:#800080; '>;</span>
            <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>total_non_dead<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    ap_max_daemons_limit <span style='color:#808030; '>=</span> last_non_dead <span style='color:#808030; '>+</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>idle_thread_count <span style='color:#808030; '>></span> max_spare_threads<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* Kill off one child */</span>
        ap_mpm_pod_signal<span style='color:#808030; '>(</span>pod<span style='color:#808030; '>,</span> TRUE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        idle_spawn_rate <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>idle_thread_count <span style='color:#808030; '>&lt;</span> min_spare_threads<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* terminate the free list */</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>free_length <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#696969; '>/* only report this condition once */</span>
            <span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> reported <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>reported<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ERR<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
                             ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"server reached MaxClients setting, consider"</span>
                             <span style='color:#0000e6; '>" raising the MaxClients setting"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                reported <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            idle_spawn_rate <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>free_length <span style='color:#808030; '>></span> idle_spawn_rate<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                free_length <span style='color:#808030; '>=</span> idle_spawn_rate<span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>idle_spawn_rate <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_INFO<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
                             ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"server seems busy, (you may need "</span>
                             <span style='color:#0000e6; '>"to increase StartServers, ThreadsPerChild "</span>
                             <span style='color:#0000e6; '>"or Min/MaxSpareThreads), "</span>
                             <span style='color:#0000e6; '>"spawning </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> children, there are around </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> idle "</span>
                             <span style='color:#0000e6; '>"threads, and </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> total children"</span><span style='color:#808030; '>,</span> free_length<span style='color:#808030; '>,</span>
                             idle_thread_count<span style='color:#808030; '>,</span> total_non_dead<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> free_length<span style='color:#800080; '>;</span> <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>i<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                make_child<span style='color:#808030; '>(</span>ap_server_conf<span style='color:#808030; '>,</span> free_slots<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#696969; '>/* the next time around we want to spawn twice as many if this</span>
<span style='color:#696969; '>             * wasn't good enough, but not if we've just done a graceful</span>
<span style='color:#696969; '>             */</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>hold_off_on_exponential_spawning<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#808030; '>-</span><span style='color:#808030; '>-</span>hold_off_on_exponential_spawning<span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>idle_spawn_rate <span style='color:#808030; '>&lt;</span> MAX_SPAWN_RATE<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                idle_spawn_rate <span style='color:#808030; '>*</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>2</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
        idle_spawn_rate <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> server_main_loop<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> remaining_children_to_start<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> child_slot<span style='color:#800080; '>;</span>
    apr_exit_why_e exitwhy<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> status<span style='color:#808030; '>,</span> processed_status<span style='color:#800080; '>;</span>
    apr_proc_t pid<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>restart_pending <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>!</span>shutdown_pending<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_wait_or_timeout<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>exitwhy<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>status<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>pid<span style='color:#808030; '>,</span> pconf<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>pid<span style='color:#808030; '>.</span>pid <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            processed_status <span style='color:#808030; '>=</span> ap_process_child_status<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>pid<span style='color:#808030; '>,</span> exitwhy<span style='color:#808030; '>,</span> status<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>processed_status <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> APEXIT_CHILDFATAL<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                shutdown_pending <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
                child_fatal <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#696969; '>/* non-fatal death... note that it's gone in the scoreboard. */</span>
            child_slot <span style='color:#808030; '>=</span> find_child_by_pid<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>pid<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>child_slot <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> ap_threads_per_child<span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
                    ap_update_child_status_from_indexes<span style='color:#808030; '>(</span>child_slot<span style='color:#808030; '>,</span> i<span style='color:#808030; '>,</span>
                                                        SERVER_DEAD<span style='color:#808030; '>,</span>
                                                        <span style='color:#808030; '>(</span>request_rec <span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>child_slot<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>pid <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
                ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>parent<span style='color:#808030; '>[</span>child_slot<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>quiescing <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>processed_status <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> APEXIT_CHILDSICK<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                    <span style='color:#696969; '>/* resource shortage, minimize the fork rate */</span>
                    idle_spawn_rate <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
                <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>remaining_children_to_start
                         <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> child_slot <span style='color:#808030; '>&lt;</span> ap_daemons_limit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                    <span style='color:#696969; '>/* we're still doing a 1-for-1 replacement of dead</span>
<span style='color:#696969; '>                     * children with new children</span>
<span style='color:#696969; '>                     */</span>
                    make_child<span style='color:#808030; '>(</span>ap_server_conf<span style='color:#808030; '>,</span> child_slot<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                    <span style='color:#808030; '>-</span><span style='color:#808030; '>-</span>remaining_children_to_start<span style='color:#800080; '>;</span>
                <span style='color:#800080; '>}</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>if</span><span style='color:#004a43; '> APR_HAS_OTHER_CHILD</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>apr_proc_other_child_alert<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>pid<span style='color:#808030; '>,</span> APR_OC_REASON_DEATH<span style='color:#808030; '>,</span>
                                                status<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* handled */</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>is_graceful<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* Great, we've probably just lost a slot in the</span>
<span style='color:#696969; '>                 * scoreboard.  Somehow we don't know about this child.</span>
<span style='color:#696969; '>                 */</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
                             ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"long lost child came home! (pid </span><span style='color:#0f69ff; '>%ld</span><span style='color:#0000e6; '>)"</span><span style='color:#808030; '>,</span>
                             <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>long</span><span style='color:#808030; '>)</span> pid<span style='color:#808030; '>.</span>pid<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#696969; '>/* Don't perform idle maintenance when a child dies,</span>
<span style='color:#696969; '>             * only do it when there's a timeout.  Remember only a</span>
<span style='color:#696969; '>             * finite number of children can die, and it's pretty</span>
<span style='color:#696969; '>             * pathological for a lot to die suddenly.</span>
<span style='color:#696969; '>             */</span>
            <span style='color:#800000; font-weight:bold; '>continue</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>remaining_children_to_start<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#696969; '>/* we hit a 1 second timeout in which none of the previous</span>
<span style='color:#696969; '>             * generation of children needed to be reaped... so assume</span>
<span style='color:#696969; '>             * they're all done, and pick up the slack if any is left.</span>
<span style='color:#696969; '>             */</span>
            startup_children<span style='color:#808030; '>(</span>remaining_children_to_start<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            remaining_children_to_start <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>/* In any event we really shouldn't do the code below because</span>
<span style='color:#696969; '>             * few of the servers we just started are in the IDLE state</span>
<span style='color:#696969; '>             * yet, so we'd mistakenly create an extra server.</span>
<span style='color:#696969; '>             */</span>
            <span style='color:#800000; font-weight:bold; '>continue</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        perform_idle_server_maintenance<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>int</span> ap_mpm_run<span style='color:#808030; '>(</span>apr_pool_t <span style='color:#808030; '>*</span> _pconf<span style='color:#808030; '>,</span> apr_pool_t <span style='color:#808030; '>*</span> plog<span style='color:#808030; '>,</span> server_rec <span style='color:#808030; '>*</span> s<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> remaining_children_to_start<span style='color:#800080; '>;</span>
    ap_log_pid<span style='color:#808030; '>(</span>pconf<span style='color:#808030; '>,</span> ap_pid_fname<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    first_server_limit <span style='color:#808030; '>=</span> server_limit<span style='color:#800080; '>;</span>
    first_thread_limit <span style='color:#808030; '>=</span> thread_limit<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>changed_limit_at_restart<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_WARNING<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> s<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: Attempt to change ServerLimit or ThreadLimit "</span>
                     <span style='color:#0000e6; '>"ignored during restart"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        changed_limit_at_restart <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>is_graceful<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_run_pre_mpm<span style='color:#808030; '>(</span>s<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>process<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>pool<span style='color:#808030; '>,</span> SB_SHARED<span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> OK<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STOPPING<span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#696969; '>/* </span><span style='color:#ffffff; background:#808000; '>fix the generation number in the global score; we just got a new,</span><span style='color:#696969; '></span>
<span style='color:#696969; '>         * cleared scoreboard</span>
<span style='color:#696969; '>         */</span>
        ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>global<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>running_generation <span style='color:#808030; '>=</span> ap_my_generation<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    set_signals<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* Don't thrash... */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>max_spare_threads <span style='color:#808030; '>&lt;</span> min_spare_threads <span style='color:#808030; '>+</span> ap_threads_per_child<span style='color:#808030; '>)</span>
        max_spare_threads <span style='color:#808030; '>=</span> min_spare_threads <span style='color:#808030; '>+</span> ap_threads_per_child<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* If we're doing a graceful_restart then we're going to see a lot</span>
<span style='color:#696969; '>     * of children exiting immediately when we get into the main loop</span>
<span style='color:#696969; '>     * below (because we just sent them AP_SIG_GRACEFUL).  This happens pretty</span>
<span style='color:#696969; '>     * rapidly... and for each one that exits we'll start a new one until</span>
<span style='color:#696969; '>     * we reach at least daemons_min_free.  But we may be permitted to</span>
<span style='color:#696969; '>     * start more than that, so we'll just keep track of how many we're</span>
<span style='color:#696969; '>     * supposed to start up without the 1 second penalty between each fork.</span>
<span style='color:#696969; '>     */</span>
    remaining_children_to_start <span style='color:#808030; '>=</span> ap_daemons_to_start<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>remaining_children_to_start <span style='color:#808030; '>></span> ap_daemons_limit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        remaining_children_to_start <span style='color:#808030; '>=</span> ap_daemons_limit<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>is_graceful<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        startup_children<span style='color:#808030; '>(</span>remaining_children_to_start<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        remaining_children_to_start <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* give the system some time to recover before kicking into</span>
<span style='color:#696969; '>         * exponential mode */</span>
        hold_off_on_exponential_spawning <span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_NOTICE<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                 <span style='color:#0000e6; '>"</span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> configured -- resuming normal operations"</span><span style='color:#808030; '>,</span>
                 ap_get_server_version<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_INFO<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                 <span style='color:#0000e6; '>"Server built: </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span> ap_get_server_built<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    restart_pending <span style='color:#808030; '>=</span> shutdown_pending <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_RUNNING<span style='color:#800080; '>;</span>
    server_main_loop<span style='color:#808030; '>(</span>remaining_children_to_start<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STOPPING<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>shutdown_pending<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* Time to gracefully shut down:</span>
<span style='color:#696969; '>         * Kill child processes, tell them to call child_exit, etc...</span>
<span style='color:#696969; '>         * (By "gracefully" we don't mean graceful in the same sense as </span>
<span style='color:#696969; '>         * "apachectl graceful" where we allow old connections to finish.)</span>
<span style='color:#696969; '>         */</span>
        ap_mpm_pod_killpg<span style='color:#808030; '>(</span>pod<span style='color:#808030; '>,</span> ap_daemons_limit<span style='color:#808030; '>,</span> FALSE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_reclaim_child_processes<span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>  <span style='color:#696969; '>/* Start with SIGTERM */</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>child_fatal<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#696969; '>/* cleanup pid file on normal shutdown */</span>
            <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>pidfile <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
            pidfile <span style='color:#808030; '>=</span> ap_server_root_relative<span style='color:#808030; '>(</span>pconf<span style='color:#808030; '>,</span> ap_pid_fname<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>pidfile <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> unlink<span style='color:#808030; '>(</span>pidfile<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_INFO<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
                             ap_server_conf<span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"removed PID file </span><span style='color:#0f69ff; '>%s</span><span style='color:#0000e6; '> (pid=</span><span style='color:#0f69ff; '>%ld</span><span style='color:#0000e6; '>)"</span><span style='color:#808030; '>,</span>
                             pidfile<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>long</span><span style='color:#808030; '>)</span> getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_NOTICE<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
                         ap_server_conf<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"caught SIGTERM, shutting down"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* we've been told to restart */</span>
    apr_signal<span style='color:#808030; '>(</span>SIGHUP<span style='color:#808030; '>,</span> SIG_IGN<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>one_process<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* not worth thinking about */</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* advance to the next generation */</span>
    <span style='color:#696969; '>/* XXX: we really need to make sure this new generation number isn't in</span>
<span style='color:#696969; '>     * use by any of the children.</span>
<span style='color:#696969; '>     */</span>
    <span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>ap_my_generation<span style='color:#800080; '>;</span>
    ap_scoreboard_image<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>global<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>running_generation <span style='color:#808030; '>=</span> ap_my_generation<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>is_graceful<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_NOTICE<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     AP_SIG_GRACEFUL_STRING
                     <span style='color:#0000e6; '>" received.  Doing graceful restart"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* wake up the children...time to die.  But we'll have more soon */</span>
        ap_mpm_pod_killpg<span style='color:#808030; '>(</span>pod<span style='color:#808030; '>,</span> ap_daemons_limit<span style='color:#808030; '>,</span> TRUE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>/* This is mostly for debugging... so that we know what is still</span>
<span style='color:#696969; '>         * gracefully dealing with existing request.</span>
<span style='color:#696969; '>         */</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* Kill 'em all.  Since the child acts the same on the parents SIGTERM </span>
<span style='color:#696969; '>         * and a SIGHUP, we may as well use the same signal, because some user</span>
<span style='color:#696969; '>         * pthreads are stealing signals from us left and right.</span>
<span style='color:#696969; '>         */</span>
        ap_mpm_pod_killpg<span style='color:#808030; '>(</span>pod<span style='color:#808030; '>,</span> ap_daemons_limit<span style='color:#808030; '>,</span> FALSE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_reclaim_child_processes<span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>  <span style='color:#696969; '>/* Start with SIGTERM */</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_NOTICE<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> ap_server_conf<span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"SIGHUP received.  Attempting to restart"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#696969; '>/* This really should be a post_config hook, but the error log is already</span>
<span style='color:#696969; '> * redirected by that point, so we need to do this in the open_logs phase.</span>
<span style='color:#696969; '> */</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> worker_open_logs<span style='color:#808030; '>(</span>apr_pool_t <span style='color:#808030; '>*</span> p<span style='color:#808030; '>,</span> apr_pool_t <span style='color:#808030; '>*</span> plog<span style='color:#808030; '>,</span>
                            apr_pool_t <span style='color:#808030; '>*</span> ptemp<span style='color:#808030; '>,</span> server_rec <span style='color:#808030; '>*</span> s<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    apr_status_t rv<span style='color:#800080; '>;</span>
    pconf <span style='color:#808030; '>=</span> p<span style='color:#800080; '>;</span>
    ap_server_conf <span style='color:#808030; '>=</span> s<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>num_listensocks <span style='color:#808030; '>=</span> ap_setup_listeners<span style='color:#808030; '>(</span>ap_server_conf<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_ALERT <span style='color:#808030; '>|</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
                     <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"no listening sockets available, shutting down"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> DONE<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>one_process<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>rv <span style='color:#808030; '>=</span> ap_mpm_pod_open<span style='color:#808030; '>(</span>pconf<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>pod<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT <span style='color:#808030; '>|</span> APLOG_STARTUP<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                         <span style='color:#0000e6; '>"Could not open pipe-of-death."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>return</span> DONE<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> OK<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> worker_pre_config<span style='color:#808030; '>(</span>apr_pool_t <span style='color:#808030; '>*</span> pconf<span style='color:#808030; '>,</span> apr_pool_t <span style='color:#808030; '>*</span> plog<span style='color:#808030; '>,</span>
                             apr_pool_t <span style='color:#808030; '>*</span> ptemp<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>int</span> restart_num <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> no_detach<span style='color:#808030; '>,</span> debug<span style='color:#808030; '>,</span> foreground<span style='color:#800080; '>;</span>
    ap_directive_t <span style='color:#808030; '>*</span>pdir<span style='color:#800080; '>;</span>
    ap_directive_t <span style='color:#808030; '>*</span>max_clients <span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    apr_status_t rv<span style='color:#800080; '>;</span>
    mpm_state <span style='color:#808030; '>=</span> AP_MPMQ_STARTING<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* make sure that "ThreadsPerChild" gets set before "MaxClients" */</span>
    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>pdir <span style='color:#808030; '>=</span> ap_conftree<span style='color:#800080; '>;</span> pdir <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span> pdir <span style='color:#808030; '>=</span> pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>next<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>strncasecmp<span style='color:#808030; '>(</span>pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>directive<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"ThreadsPerChild"</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>15</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>max_clients<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>          <span style='color:#696969; '>/* we're in the clear, got ThreadsPerChild first */</span>
            <span style='color:#800080; '>}</span>
            <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
                <span style='color:#696969; '>/* now to swap the data */</span>
                ap_directive_t temp<span style='color:#800080; '>;</span>
                temp<span style='color:#808030; '>.</span>directive <span style='color:#808030; '>=</span> pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>directive<span style='color:#800080; '>;</span>
                temp<span style='color:#808030; '>.</span>args <span style='color:#808030; '>=</span> pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>args<span style='color:#800080; '>;</span>
                <span style='color:#696969; '>/* Make sure you don't change 'next', or you may get loops! */</span>
                <span style='color:#696969; '>/* XXX: first_child, parent, and data can never be set</span>
<span style='color:#696969; '>                 * for these directives, right? -aaron */</span>
                temp<span style='color:#808030; '>.</span>filename <span style='color:#808030; '>=</span> pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>filename<span style='color:#800080; '>;</span>
                temp<span style='color:#808030; '>.</span>line_num <span style='color:#808030; '>=</span> pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>line_num<span style='color:#800080; '>;</span>
                pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>directive <span style='color:#808030; '>=</span> max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>directive<span style='color:#800080; '>;</span>
                pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>args <span style='color:#808030; '>=</span> max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>args<span style='color:#800080; '>;</span>
                pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>filename <span style='color:#808030; '>=</span> max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>filename<span style='color:#800080; '>;</span>
                pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>line_num <span style='color:#808030; '>=</span> max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>line_num<span style='color:#800080; '>;</span>
                max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>directive <span style='color:#808030; '>=</span> temp<span style='color:#808030; '>.</span>directive<span style='color:#800080; '>;</span>
                max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>args <span style='color:#808030; '>=</span> temp<span style='color:#808030; '>.</span>args<span style='color:#800080; '>;</span>
                max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>filename <span style='color:#808030; '>=</span> temp<span style='color:#808030; '>.</span>filename<span style='color:#800080; '>;</span>
                max_clients<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>line_num <span style='color:#808030; '>=</span> temp<span style='color:#808030; '>.</span>line_num<span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
        <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>max_clients
                 <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> strncasecmp<span style='color:#808030; '>(</span>pdir<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>directive<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"MaxClients"</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            max_clients <span style='color:#808030; '>=</span> pdir<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    debug <span style='color:#808030; '>=</span> ap_exists_config_define<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"DEBUG"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>debug<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        foreground <span style='color:#808030; '>=</span> one_process <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        no_detach <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
        one_process <span style='color:#808030; '>=</span> ap_exists_config_define<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"ONE_PROCESS"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        no_detach <span style='color:#808030; '>=</span> ap_exists_config_define<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"NO_DETACH"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        foreground <span style='color:#808030; '>=</span> ap_exists_config_define<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"FOREGROUND"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* sigh, want this only the second time around */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>restart_num<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        is_graceful <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
        rv <span style='color:#808030; '>=</span> apr_pollset_create<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>event_pollset<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> plog<span style='color:#808030; '>,</span>
                                APR_POLLSET_THREADSAFE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                         <span style='color:#0000e6; '>"Couldn't create a Thread Safe Pollset. "</span>
                         <span style='color:#0000e6; '>"Is it supported on your platform?"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>return</span> HTTP_INTERNAL_SERVER_ERROR<span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        apr_pollset_destroy<span style='color:#808030; '>(</span>event_pollset<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>one_process <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>!</span>foreground<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
            rv <span style='color:#808030; '>=</span> apr_proc_detach<span style='color:#808030; '>(</span>no_detach <span style='color:#800080; '>?</span> APR_PROC_DETACH_FOREGROUND
                                 <span style='color:#800080; '>:</span> APR_PROC_DETACH_DAEMONIZE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>rv <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> APR_SUCCESS<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
                ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_CRIT<span style='color:#808030; '>,</span> rv<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                             <span style='color:#0000e6; '>"apr_proc_detach failed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                <span style='color:#800000; font-weight:bold; '>return</span> HTTP_INTERNAL_SERVER_ERROR<span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
        <span style='color:#800080; '>}</span>
        parent_pid <span style='color:#808030; '>=</span> ap_my_pid <span style='color:#808030; '>=</span> getpid<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    unixd_pre_config<span style='color:#808030; '>(</span>ptemp<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    ap_listen_pre_config<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    ap_daemons_to_start <span style='color:#808030; '>=</span> DEFAULT_START_DAEMON<span style='color:#800080; '>;</span>
    min_spare_threads <span style='color:#808030; '>=</span> DEFAULT_MIN_FREE_DAEMON <span style='color:#808030; '>*</span> DEFAULT_THREADS_PER_CHILD<span style='color:#800080; '>;</span>
    max_spare_threads <span style='color:#808030; '>=</span> DEFAULT_MAX_FREE_DAEMON <span style='color:#808030; '>*</span> DEFAULT_THREADS_PER_CHILD<span style='color:#800080; '>;</span>
    ap_daemons_limit <span style='color:#808030; '>=</span> server_limit<span style='color:#800080; '>;</span>
    ap_threads_per_child <span style='color:#808030; '>=</span> DEFAULT_THREADS_PER_CHILD<span style='color:#800080; '>;</span>
    ap_pid_fname <span style='color:#808030; '>=</span> DEFAULT_PIDLOG<span style='color:#800080; '>;</span>
    ap_lock_fname <span style='color:#808030; '>=</span> DEFAULT_LOCKFILE<span style='color:#800080; '>;</span>
    ap_max_requests_per_child <span style='color:#808030; '>=</span> DEFAULT_MAX_REQUESTS_PER_CHILD<span style='color:#800080; '>;</span>
    ap_extended_status <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> AP_MPM_WANT_SET_MAX_MEM_FREE</span>
    ap_max_mem_free <span style='color:#808030; '>=</span> APR_ALLOCATOR_MAX_FREE_UNLIMITED<span style='color:#800080; '>;</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>
    apr_cpystrn<span style='color:#808030; '>(</span>ap_coredump_dir<span style='color:#808030; '>,</span> ap_server_root<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>ap_coredump_dir<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> OK<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> event_hooks<span style='color:#808030; '>(</span>apr_pool_t <span style='color:#808030; '>*</span> p<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#696969; '>/* The worker open_logs phase must run before the core's, or stderr</span>
<span style='color:#696969; '>     * will be redirected to a file, and the messages won't print to the</span>
<span style='color:#696969; '>     * console.</span>
<span style='color:#696969; '>     */</span>
    <span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span><span style='color:#800000; font-weight:bold; '>const</span> aszSucc<span style='color:#808030; '>[</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span> <span style='color:#0000e6; '>"core.c"</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
    one_process <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    ap_hook_open_logs<span style='color:#808030; '>(</span>worker_open_logs<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> aszSucc<span style='color:#808030; '>,</span> APR_HOOK_MIDDLE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* we need to set the MPM state before other pre-config hooks use MPM query</span>
<span style='color:#696969; '>     * to retrieve it, so register as REALLY_FIRST</span>
<span style='color:#696969; '>     */</span>
    ap_hook_pre_config<span style='color:#808030; '>(</span>worker_pre_config<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> APR_HOOK_REALLY_FIRST<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>set_daemons_to_start<span style='color:#808030; '>(</span>cmd_parms <span style='color:#808030; '>*</span>cmd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>,</span>
                                        <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>err <span style='color:#808030; '>=</span> ap_check_cmd_context<span style='color:#808030; '>(</span>cmd<span style='color:#808030; '>,</span> GLOBAL_ONLY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>err <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
        
    ap_daemons_to_start <span style='color:#808030; '>=</span> atoi<span style='color:#808030; '>(</span>arg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>set_min_spare_threads<span style='color:#808030; '>(</span>cmd_parms <span style='color:#808030; '>*</span> cmd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>,</span>
                                         <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>err <span style='color:#808030; '>=</span> ap_check_cmd_context<span style='color:#808030; '>(</span>cmd<span style='color:#808030; '>,</span> GLOBAL_ONLY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>err <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    min_spare_threads <span style='color:#808030; '>=</span> atoi<span style='color:#808030; '>(</span>arg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>min_spare_threads <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: detected MinSpareThreads set to non-positive."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"Resetting to 1 to avoid almost certain Apache failure."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"Please read the documentation."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        min_spare_threads <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>set_max_spare_threads<span style='color:#808030; '>(</span>cmd_parms <span style='color:#808030; '>*</span> cmd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>,</span>
                                         <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>err <span style='color:#808030; '>=</span> ap_check_cmd_context<span style='color:#808030; '>(</span>cmd<span style='color:#808030; '>,</span> GLOBAL_ONLY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>err <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    max_spare_threads <span style='color:#808030; '>=</span> atoi<span style='color:#808030; '>(</span>arg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>set_max_clients<span style='color:#808030; '>(</span>cmd_parms <span style='color:#808030; '>*</span> cmd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>,</span>
                                   <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> max_clients<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>err <span style='color:#808030; '>=</span> ap_check_cmd_context<span style='color:#808030; '>(</span>cmd<span style='color:#808030; '>,</span> GLOBAL_ONLY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>err <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>/* It is ok to use ap_threads_per_child here because we are</span>
<span style='color:#696969; '>     * sure that it gets set before MaxClients in the pre_config stage. */</span>
    max_clients <span style='color:#808030; '>=</span> atoi<span style='color:#808030; '>(</span>arg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>max_clients <span style='color:#808030; '>&lt;</span> ap_threads_per_child<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: MaxClients (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>) must be at least as large"</span><span style='color:#808030; '>,</span>
                     max_clients<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>" as ThreadsPerChild (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>). Automatically"</span><span style='color:#808030; '>,</span>
                     ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>" increasing MaxClients to </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>."</span><span style='color:#808030; '>,</span> ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        max_clients <span style='color:#808030; '>=</span> ap_threads_per_child<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    ap_daemons_limit <span style='color:#808030; '>=</span> max_clients <span style='color:#808030; '>/</span> ap_threads_per_child<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>max_clients <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>max_clients <span style='color:#808030; '>%</span> ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: MaxClients (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>) is not an integer multiple"</span><span style='color:#808030; '>,</span>
                     max_clients<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>" of ThreadsPerChild (</span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>), lowering MaxClients to </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span>
                     ap_threads_per_child<span style='color:#808030; '>,</span>
                     ap_daemons_limit <span style='color:#808030; '>*</span> ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>" for a maximum of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> child processes,"</span><span style='color:#808030; '>,</span>
                     ap_daemons_limit<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        max_clients <span style='color:#808030; '>=</span> ap_daemons_limit <span style='color:#808030; '>*</span> ap_threads_per_child<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_daemons_limit <span style='color:#808030; '>></span> server_limit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
       ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                    <span style='color:#0000e6; '>"WARNING: MaxClients of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> would require </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> servers,"</span><span style='color:#808030; '>,</span>
                    max_clients<span style='color:#808030; '>,</span> ap_daemons_limit<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                    <span style='color:#0000e6; '>" and would exceed the ServerLimit value of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>."</span><span style='color:#808030; '>,</span>
                    server_limit<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                    <span style='color:#0000e6; '>" Automatically lowering MaxClients to </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>.  To increase,"</span><span style='color:#808030; '>,</span>
                    server_limit <span style='color:#808030; '>*</span> ap_threads_per_child<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                    <span style='color:#0000e6; '>" please see the ServerLimit directive."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       ap_daemons_limit <span style='color:#808030; '>=</span> server_limit<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_daemons_limit <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: Require MaxClients > 0, setting to 1"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_daemons_limit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>set_threads_per_child<span style='color:#808030; '>(</span>cmd_parms <span style='color:#808030; '>*</span> cmd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>,</span>
                                         <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>err <span style='color:#808030; '>=</span> ap_check_cmd_context<span style='color:#808030; '>(</span>cmd<span style='color:#808030; '>,</span> GLOBAL_ONLY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>err <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    ap_threads_per_child <span style='color:#808030; '>=</span> atoi<span style='color:#808030; '>(</span>arg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_threads_per_child <span style='color:#808030; '>></span> thread_limit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: ThreadsPerChild of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> exceeds ThreadLimit "</span>
                     <span style='color:#0000e6; '>"value of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span> ap_threads_per_child<span style='color:#808030; '>,</span> thread_limit<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"threads, lowering ThreadsPerChild to </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>. To increase, please"</span>
                     <span style='color:#0000e6; '>" see the"</span><span style='color:#808030; '>,</span> thread_limit<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>" ThreadLimit directive."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_threads_per_child <span style='color:#808030; '>=</span> thread_limit<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>ap_threads_per_child <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: Require ThreadsPerChild > 0, setting to 1"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_threads_per_child <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>set_server_limit <span style='color:#808030; '>(</span>cmd_parms <span style='color:#808030; '>*</span>cmd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> tmp_server_limit<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>err <span style='color:#808030; '>=</span> ap_check_cmd_context<span style='color:#808030; '>(</span>cmd<span style='color:#808030; '>,</span> GLOBAL_ONLY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>err <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    tmp_server_limit <span style='color:#808030; '>=</span> atoi<span style='color:#808030; '>(</span>arg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* you cannot change ServerLimit across a restart; ignore</span>
<span style='color:#696969; '>     * any such attempts</span>
<span style='color:#696969; '>     */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>first_server_limit <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
        tmp_server_limit <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> server_limit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* how do we log a message?  the error log is a bit bucket at this</span>
<span style='color:#696969; '>         * point; we'll just have to set a flag so that ap_mpm_run()</span>
<span style='color:#696969; '>         * logs a warning later</span>
<span style='color:#696969; '>         */</span>
        changed_limit_at_restart <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    server_limit <span style='color:#808030; '>=</span> tmp_server_limit<span style='color:#800080; '>;</span>
  
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>server_limit <span style='color:#808030; '>></span> MAX_SERVER_LIMIT<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
       ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                    <span style='color:#0000e6; '>"WARNING: ServerLimit of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> exceeds compile time limit "</span>
                    <span style='color:#0000e6; '>"of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> servers,"</span><span style='color:#808030; '>,</span> server_limit<span style='color:#808030; '>,</span> MAX_SERVER_LIMIT<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                    <span style='color:#0000e6; '>" lowering ServerLimit to </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>."</span><span style='color:#808030; '>,</span> MAX_SERVER_LIMIT<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
       server_limit <span style='color:#808030; '>=</span> MAX_SERVER_LIMIT<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>server_limit <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: Require ServerLimit > 0, setting to 1"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        server_limit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>set_thread_limit<span style='color:#808030; '>(</span>cmd_parms <span style='color:#808030; '>*</span> cmd<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#808030; '>*</span>dummy<span style='color:#808030; '>,</span>
                                    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>arg<span style='color:#808030; '>)</span>
<span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>int</span> tmp_thread_limit<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>char</span> <span style='color:#808030; '>*</span>err <span style='color:#808030; '>=</span> ap_check_cmd_context<span style='color:#808030; '>(</span>cmd<span style='color:#808030; '>,</span> GLOBAL_ONLY<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>err <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    tmp_thread_limit <span style='color:#808030; '>=</span> atoi<span style='color:#808030; '>(</span>arg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>/* you cannot change ThreadLimit across a restart; ignore</span>
<span style='color:#696969; '>     * any such attempts</span>
<span style='color:#696969; '>     */</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>first_thread_limit <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> tmp_thread_limit <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> thread_limit<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>/* how do we log a message?  the error log is a bit bucket at this</span>
<span style='color:#696969; '>         * point; we'll just have to set a flag so that ap_mpm_run()</span>
<span style='color:#696969; '>         * logs a warning later</span>
<span style='color:#696969; '>         */</span>
        changed_limit_at_restart <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    thread_limit <span style='color:#808030; '>=</span> tmp_thread_limit<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>thread_limit <span style='color:#808030; '>></span> MAX_THREAD_LIMIT<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: ThreadLimit of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> exceeds compile time limit "</span>
                     <span style='color:#0000e6; '>"of </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '> servers,"</span><span style='color:#808030; '>,</span> thread_limit<span style='color:#808030; '>,</span> MAX_THREAD_LIMIT<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>" lowering ThreadLimit to </span><span style='color:#0f69ff; '>%d</span><span style='color:#0000e6; '>."</span><span style='color:#808030; '>,</span> MAX_THREAD_LIMIT<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        thread_limit <span style='color:#808030; '>=</span> MAX_THREAD_LIMIT<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>thread_limit <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        ap_log_error<span style='color:#808030; '>(</span>APLOG_MARK<span style='color:#808030; '>,</span> APLOG_STARTUP<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>
                     <span style='color:#0000e6; '>"WARNING: Require ThreadLimit > 0, setting to 1"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        thread_limit <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>const</span> command_rec event_cmds<span style='color:#808030; '>[</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span>
    UNIX_DAEMON_COMMANDS<span style='color:#808030; '>,</span>
    LISTEN_COMMANDS<span style='color:#808030; '>,</span>
    AP_INIT_TAKE1<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"StartServers"</span><span style='color:#808030; '>,</span> set_daemons_to_start<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> RSRC_CONF<span style='color:#808030; '>,</span>
                  <span style='color:#0000e6; '>"Number of child processes launched at server startup"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
    AP_INIT_TAKE1<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"ServerLimit"</span><span style='color:#808030; '>,</span> set_server_limit<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> RSRC_CONF<span style='color:#808030; '>,</span>
                  <span style='color:#0000e6; '>"Maximum number of child processes for this run of Apache"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
    AP_INIT_TAKE1<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"MinSpareThreads"</span><span style='color:#808030; '>,</span> set_min_spare_threads<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> RSRC_CONF<span style='color:#808030; '>,</span>
                  <span style='color:#0000e6; '>"Minimum number of idle threads, to handle request spikes"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
    AP_INIT_TAKE1<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"MaxSpareThreads"</span><span style='color:#808030; '>,</span> set_max_spare_threads<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> RSRC_CONF<span style='color:#808030; '>,</span>
                  <span style='color:#0000e6; '>"Maximum number of idle threads"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
    AP_INIT_TAKE1<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"MaxClients"</span><span style='color:#808030; '>,</span> set_max_clients<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> RSRC_CONF<span style='color:#808030; '>,</span>
                  <span style='color:#0000e6; '>"Maximum number of threads alive at the same time"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
    AP_INIT_TAKE1<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"ThreadsPerChild"</span><span style='color:#808030; '>,</span> set_threads_per_child<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> RSRC_CONF<span style='color:#808030; '>,</span>
                  <span style='color:#0000e6; '>"Number of threads each child creates"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
    AP_INIT_TAKE1<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"ThreadLimit"</span><span style='color:#808030; '>,</span> set_thread_limit<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> RSRC_CONF<span style='color:#808030; '>,</span>
                  <span style='color:#0000e6; '>"Maximum number of worker threads per child process for this "</span>
                  <span style='color:#0000e6; '>"run of Apache - Upper limit for ThreadsPerChild"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
    <span style='color:#800080; '>{</span><span style='color:#7d0045; '>NULL</span><span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
module AP_MODULE_DECLARE_DATA mpm_event_module <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span>
    MPM20_MODULE_STUFF<span style='color:#808030; '>,</span>
    ap_mpm_rewrite_args<span style='color:#808030; '>,</span>        <span style='color:#696969; '>/* hook to run before apache parses args */</span>
    <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>                       <span style='color:#696969; '>/* create per-directory config structure */</span>
    <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>                       <span style='color:#696969; '>/* merge per-directory config structures */</span>
    <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>                       <span style='color:#696969; '>/* create per-server config structure */</span>
    <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span>                       <span style='color:#696969; '>/* merge per-server config structures */</span>
    event_cmds<span style='color:#808030; '>,</span>                 <span style='color:#696969; '>/* command apr_table_t */</span>
    event_hooks                 <span style='color:#696969; '>/* register_hooks */</span>
<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
</pre>
